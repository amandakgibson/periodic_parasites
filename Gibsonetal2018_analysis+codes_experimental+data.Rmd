---
title: "Gibson2018_analysis+codes_experimental+data"
author: "Amanda Gibson"
date: "May 15, 2018"
output: pdf_document
---

For paper Periodic, parasite-mediated selection for and against sex; Gibson, Delph, Vergara, and Lively 2018
Packages used

```{r}
library(reshape)
library(matrixStats)
library(Hmisc)
library(aod)
library(geepack)
library(bbmle)
library(emdbook)
library(nortest)
options(digits=4)
```

Data sets

```{r}
# experimental mesocosms; adult females
ba0<-read.csv("Bins_adults.csv")
ba<-subset(ba0,ba0$sex==0 & ba0$ploidy>0)

# experimental mesocosms; adults females + male
bm<-read.csv("Bins_adults_withmales.csv")
bm<-subset(bm,bm$ploidy>0)
bm2<-subset(bm,bm$ploidy==2)

# experimental mesocosms; babies
bb0<-read.csv("Bins_babies.csv")
bb<-subset(bb0,bb0$ploidy>0)

# experimental mesocosms; adults+babies
bab<-read.csv("Bins_adults+babies.csv")
bab<-subset(bab,bab$ploidy>0)

```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - Microphallus infection rate in sexual and asexual snails in experimental replicates. Females. Table S4A

```{r}
# subset by ploidy and treatment
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# group by tank and year
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)

geefit2<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
wald.test(b = coef(geefit2), Sigma = vcov(geefit2), Terms = 10)


geefit3<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")

anova(geefit3,test="LRT")
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - All castrating trematode infection rate in sexual and asexual snails in experimental replicates. Females. Table S4B

```{r}
# control asexuals
aCT=tapply(aC$castrated,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$castrated,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","cas")

Ca<-cbind(LaCT,LaCM$cas)
names(Ca)=c("year","replicate","total","cas")
healthy=Ca$total-Ca$cas
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$castrated,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$castrated,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","cas")

Ea<-cbind(LaET,LaEM$cas)
names(Ea)=c("year","replicate","total","cas")
healthy=Ea$total-Ea$cas
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$castrated,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$castrated,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","cas")

Cs<-cbind(LsCT,LsCM$cas)
names(Cs)=c("year","replicate","total","cas")
healthy=Cs$total-Cs$cas
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$castrated,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$castrated,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","cas")

Es<-cbind(LsET,LsEM$cas)
names(Es)=c("year","replicate","total","cas")
healthy=Es$total-Es$cas
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

geefit1<-geeglm( cbind(cas,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
anova(geefit1,test="LRT")
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)

geefit2<-geeglm( cbind(cas,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
anova(geefit2,test="LRT")
summary(geefit2)
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - Microphallus infection rate in sexual and asexual snails in experimental replicates. Females + Males. 

```{r}
# subset by ploidy and treatment
aC=subset(bm,bm$treatment==0 & bm$ploidy==3)
aE=subset(bm,bm$treatment==1 & bm$ploidy==3)
sC=subset(bm,bm$treatment==0 & bm$ploidy==2)
sE=subset(bm,bm$treatment==1 & bm$ploidy==2)

# control asexuals
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
summary(geefit1)
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)

geefit2<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
anova(geefit2,test="LRT")
summary(geefit2)
wald.test(b = coef(geefit2), Sigma = vcov(geefit2), Terms = 10)

geefit3<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
anova(geefit3,test="LRT")

```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Calculations

```{r}
# increase in infection from control to exposed tanks#
# control tanks
# all females, yes/no mic by tank, year
C<-subset(ba,ba$treatment==0)
tC=tapply(C$mic,list(C$replicate,C$year),length)
mC=tapply(C$mic,list(C$replicate,C$year),sum)
fC=mC/tC

# exposed tanks
# all females, yes/no mic by tank, year
E<-subset(ba,ba$treatment==1)
tE=tapply(E$mic,list(E$replicate,E$year),length)
mE=tapply(E$mic,list(E$replicate,E$year),sum)
fE=mE/tE

mean=c(mean(fC),mean(fE))
mean(fE)/mean(fC) # fold increase
se=c(sd(fC)/sqrt(24),sd(fE)/sqrt(24))

# sample sizes
mean=c(mean(tC),mean(tE))
se=c(sd(tC)/sqrt(24),sd(tE)/sqrt(24))

######
# differential infection in control tanks#
Ca<-subset(ba, ba$treatment==0 &ba$ploidy==3)
tCa=tapply(Ca$mic,list(Ca$replicate,Ca$year),length)
mCa=tapply(Ca$mic,list(Ca$replicate,Ca$year),sum)
fCa=mCa/tCa

Cs<-subset(ba,ba$treatment==0 & ba$ploidy==2)
tCs=tapply(Cs$mic,list(Cs$replicate,Cs$year),length)
mCs=tapply(Cs$mic,list(Cs$replicate,Cs$year),sum)
fCs=mCs/tCs

m1=mean(fCa)
m2=mean(fCs)
se1=sd(fCa)/sqrt(24)
se2=sd(fCs)/sqrt(24)

fold<-mean(fCa)/mean(fCs) # fold increase
se_fold=fold*sqrt(((se1/m1)^2)+((se2/m2)^2))

# sample sizes
mean=c(mean(tCa),mean(tCs))
se=c(sd(tCa)/sqrt(24),sd(tCs)/sqrt(24))

########
# differential infection in exposed tanks#
Ea<-subset(ba,ba$treatment==1 &ba$ploidy==3)
tEa=tapply(Ea$mic,list(Ea$replicate,Ea$year),length)
mEa=tapply(Ea$mic,list(Ea$replicate,Ea$year),sum)
fEa=mEa/tEa

Es<-subset(ba,ba$treatment==1 & ba$ploidy==2)
tEs=tapply(Es$mic,list(Es$replicate,Es$year),length)
mEs=tapply(Es$mic,list(Es$replicate,Es$year),sum)
fEs=mEs/tEs

m1=mean(fEa)
m2=mean(fEs)
se1=sd(fEa)/sqrt(24)
se2=sd(fEs)/sqrt(24)

fold<-mean(fEa)/mean(fEs) # fold increase
se_fold=fold*sqrt(((se1/m1)^2)+((se2/m2)^2))

# sample sizes
mean=c(mean(tEa),mean(tEs))
se=c(sd(tEa)/sqrt(24),sd(tEs)/sqrt(24))

# overall sample sizes
ta<-cbind(tCa,tEa)
mean(ta)
sd(ta)/sqrt(48)

ts<-cbind(tCs,tEs)
mean(ts)
sd(ts)/sqrt(48)
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Figure 2A

```{r}
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# now divide each subset by tank and year
# control asexuals
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
Ca=cbind(Ca,healthy,ploidy,treatment)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
Ea=cbind(Ea,healthy,ploidy,treatment)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
Cs=cbind(Cs,healthy,ploidy,treatment)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
Es=cbind(Es,healthy,ploidy,treatment)

# now bring them all together
inf<-rbind(Ca,Cs,Ea,Es)
freq=inf$mic/inf$total
inf=cbind(inf,freq)

# plotting
par(mar=c(4,4,4,4))
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(inf$freq~inf$ploidy*inf$treatment,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=2,cex.axis=1.5,names=c("Sexual","Asexual","Sexual","Asexual"),
        xlab="",
        col=c("#ca0020","#0571b0"),outcex=1.5)
abline(v=2.5,lty=3)
text(1.5,0.9,"Control",cex=2)
text(3.5,0.9,"Exposed",cex=2)
```
Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. quasi-GLM - proportion of offspring asexual in control and exposed mesocosms. Females, all years. Table S5A

```{r}
aC=subset(bb,bb$treatment==0 & bb$ploidy==3)
aE=subset(bb,bb$treatment==1 & bb$ploidy==3)
sC=subset(bb,bb$treatment==0 & bb$ploidy==2)
sE=subset(bb,bb$treatment==1 & bb$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)

lrfit<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
            family = binomial,data=T)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/40 

# quasi
lrfitq<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
             family = quasibinomial,data=T)

lrfitq2<-glm( cbind(triploid,diploid) ~ treatment+factor(year), 
              family = quasibinomial,data=T)
anova(lrfitq,lrfitq2,test="F")

lrfitq3<-glm( cbind(triploid,diploid) ~ treatment, 
              family = quasibinomial,data=T)
anova(lrfitq2,lrfitq3,test="F")

lrfitq4<-glm( cbind(triploid,diploid) ~ factor(year), 
              family = quasibinomial,data=T)
anova(lrfitq2,lrfitq4,test="F")
```
Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. quasi-GLM - proportion of offspring asexual in control and exposed mesocosms. Females, 2013-2015 Table S5B

```{r}
Tlat<-subset(T,T$year!=2012)
lrfit<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
            family = binomial,data=Tlat)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/30

# quasibinomial
lrfitq<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
             family = quasibinomial,data=Tlat)
lrfitq2<-glm( cbind(triploid,diploid) ~ treatment+factor(year), 
              family = quasibinomial,data=Tlat)
anova(lrfitq,lrfitq2,test="F")

lrfitq3<-glm( cbind(triploid,diploid) ~ treatment, 
              family = quasibinomial,data=Tlat)
anova(lrfitq2,lrfitq3,test="F")

lrfitq4<-glm( cbind(triploid,diploid) ~ factor(year), 
              family = quasibinomial,data=Tlat)
anova(lrfitq2,lrfitq4,test="F")
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Calculations

```{r}
#fraction asexual babies in control v exposed
aC=subset(bb,bb$treatment==0 & bb$ploidy==3)
aE=subset(bb,bb$treatment==1 & bb$ploidy==3)
sC=subset(bb,bb$treatment==0 & bb$ploidy==2)
sE=subset(bb,bb$treatment==1 & bb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tf=cbind(T,freq,sum)

# sample sizes
mean(Tf$sum)
sd(Tf$sum)/sqrt(length(Tf$sum))

###########2012-2015####################
mean<-tapply(Tf$freq,list(Tf$treatment),mean)
sd<-tapply(Tf$freq,list(Tf$treatment),sd)
se<-sd/sqrt(length(Tf$treatment)/2)

# sample sizes
mean<-tapply(Tf$sum,list(Tf$treatment),mean)
sd<-tapply(Tf$sum,list(Tf$treatment),sd)
se<-sd/sqrt(length(Tf$treatment)/2)

###########2013-2015####################
Tf2<-subset(Tf,Tf$year>2012)

mean<-tapply(Tf2$freq,list(Tf2$treatment),mean)
sd<-tapply(Tf2$freq,list(Tf2$treatment),sd)
se<-sd/sqrt(length(Tf2$treatment)/2)

# sample sizes
mean<-tapply(Tf2$sum,list(Tf2$treatment),mean)
sd<-tapply(Tf2$sum,list(Tf2$treatment),sd)
se<-sd/sqrt(length(Tf2$treatment)/2)

####################
# fold-change
babb<-subset(bab,bab$cohort=="baby")
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfbabies=cbind(T,freq,sum)
cohort=rep("baby",length(Tfbabies$treatment))
Tfbabies=cbind(Tfbabies,cohort)

# adults
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tf=rbind(Tfadults,Tfbabies)
Tf$treatment<-factor(Tf$treatment, levels=c("control","exposed"))
Tfadults$treatment<-factor(Tfadults$treatment, levels=c("control","exposed"))
Tfbabies$treatment<-factor(Tfbabies$treatment, levels=c("control","exposed"))

#means
Tfa=mean(Tf$freq[1:48])
Tfa_se=sd(Tf$freq[1:48])/sqrt(48)

TfbE=mean(Tf$freq[49:72])
TfbE_se=sd(Tf$freq[49:72])/sqrt(24)

TfbC=mean(Tf$freq[73:96])
TfbC_se=sd(Tf$freq[73:96])/sqrt(24)

#fold changes
foldC=TfbC/Tfa
se_foldC=foldC*sqrt(((Tfa_se/Tfa)^2)+((TfbC_se/TfbC)^2))

foldE=TfbE/Tfa
se_foldE=foldE*sqrt(((Tfa_se/Tfa)^2)+((TfbE_se/TfbE)^2))

#### exclude 2012
Tf2<-subset(Tf,Tf$year>2012)

#means
Tfa=mean(Tf2$freq[1:36])
Tfa_se=sd(Tf2$freq[1:36])/sqrt(36)

TfbE=mean(Tf2$freq[37:54])
TfbE_se=sd(Tf2$freq[37:54])/sqrt(18)

TfbC=mean(Tf2$freq[55:72])
TfbC_se=sd(Tf2$freq[55:72])/sqrt(18)

#fold changes
foldC=TfbC/Tfa
se_foldC=foldC*sqrt(((Tfa_se/Tfa)^2)+((TfbC_se/TfbC)^2))

foldE=TfbE/Tfa
se_foldE=foldE*sqrt(((Tfa_se/Tfa)^2)+((TfbE_se/TfbE)^2))

####################
#frequencies of triploid and diploid adults in tanks
#includes males (see methods)

# subset by ploidy and treatment
aC=subset(bm,bm$treatment==0 & bm$ploidy==3)
aE=subset(bm,bm$treatment==1 & bm$ploidy==3)
sC=subset(bm,bm$treatment==0 & bm$ploidy==2)
sE=subset(bm,bm$treatment==1 & bm$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tf=cbind(T,freq,sum)

mean(Tf$freq)
sd(Tf$freq)/sqrt(length(Tf$freq))

# sample sizes
mean(Tf$sum)
sd(Tf$sum)/sqrt(length(Tf$sum))

###########2012-2015####################
# by treatment
mean<-tapply(Tf$freq,list(Tf$treatment),mean)
sd<-tapply(Tf$freq,list(Tf$treatment),sd)
se<-sd/sqrt(length(Tf$treatment)/2)

# sample sizes
mean<-tapply(Tf$sum,list(Tf$treatment),mean)
sd<-tapply(Tf$sum,list(Tf$treatment),sd)
se<-sd/sqrt(length(Tf$treatment)/2)

###########2013-2015####################
Tf2<-subset(Tf,Tf$year>2012)
mean(Tf2$freq)
sd(Tf2$freq)/sqrt(36)

mean<-tapply(Tf2$freq,list(Tf2$treatment),mean)
sd<-tapply(Tf2$freq,list(Tf2$treatment),sd)
se<-sd/sqrt(length(Tf2$treatment)/2)

# sample sizes
mean<-tapply(Tf2$sum,list(Tf2$treatment),mean)
sd<-tapply(Tf2$sum,list(Tf2$treatment),sd)
se<-sd/sqrt(length(Tf2$treatment)/2)

#################
# ambiguous DNA content
# babies
d<-subset(bb0,bb0$ploidy!="NA")
l<-tapply(d$ploidy,list(d$year,d$tank),length)

#zero
d2<-subset(bb0,bb0$ploidy==0)
l2<-tapply(d2$ploidy,list(d2$year,d2$tank),length)
l2[is.na(l2)] <- 0

mean(l2/l)
sd(l2/l)/sqrt(48)

# adults
d<-subset(ba0,ba0$ploidy!="NA")
l<-tapply(d$ploidy,list(d$year,d$tank),length)

#zero
d2<-subset(ba0,ba0$ploidy==0)
l2<-tapply(d2$ploidy,list(d2$year,d2$tank),length)
l2[is.na(l2)] <- 0

mean(l2/l)
sd(l2/l)/sqrt(48)
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Figure 2B

```{r}
babb<-subset(bab,bab$cohort=="baby")
# subset by ploidy and treatment
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfbabies=cbind(T,freq,sum)
cohort=rep("baby",length(Tfbabies$treatment))
Tfbabies=cbind(Tfbabies,cohort)

# now adults!
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tf=rbind(Tfadults,Tfbabies)
Tf$treatment<-factor(Tf$treatment, levels=c("control","exposed"))
Tfadults$treatment<-factor(Tfadults$treatment, levels=c("control","exposed"))
Tfbabies$treatment<-factor(Tfbabies$treatment, levels=c("control","exposed"))

# plot
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(Tf$freq~Tf$treatment*Tf$cohort,
        ylim=c(0,1),
        lwd=2,cex.axis=1.5,names=c("Control","Exposed","Control","Exposed"),
        col=c("#bdbdbd","#636363"),outcex=1.5)
abline(v=2.5,lty=3)
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Prepping data for model fit

```{r}
babb<-subset(bab,bab$cohort=="baby")
# subset by ploidy and treatment
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep(2,length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep(1,length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
sum=T$triploid+T$diploid
Tfbabies=data.frame(cbind(T$year,T$replicate,T$treatment,T$triploid,sum))
names(Tfbabies)=c("year","rep","treatment","y","z")

# adults
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba, baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge 
treatment=rep(1,length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep(0,length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
Tfadults=cbind(T,freq)

asex=cbind(Tfbabies,Tfadults$freq)
names(asex)=c("year","rep","treatment","y","z","x")

asex$year<-as.factor(asex$year)
asex$treatment<-as.factor(asex$treatment)
asex$rep<-as.factor(asex$rep)

#sort by mpg (ascending) and cyl (descending)
asex <- asex[order(asex$treatment,asex$year),] 
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Model selection. Table 2

```{r}
attach(asex)

# model 1: No cost of sex
m1 = x

# model 2: 2-fold cost of sex
m2 = (x*2)/(1+x)

# model 3: c-fold cost of sex
m3 = function(F0, c){ # function of F0 (x in prior models) and c, the cost of sex
  (F0*c)/(1+F0*(c-1))}

# model 4: c-fold cost of sex with treatment variation
m4 = function(F0,c0,c.exp){ # c0 is our base cost in control, modifies for exposed
  cdiff=c(0,c.exp) # this value is added to our cost - nothing added for control
  cost=c0+cdiff[asex$treatment] # the cost that we'll use, with the addition of cdiff indexed by treatment
  m4.tr=(F0*cost)/(1+F0*(cost-1)) # the same function as above
}

# negative log-likelihood functions
# model 1
NLL.m1<--sum(dbinom(y,size=z,prob=m1,log=TRUE)) 
# model 1.bb
NLL.m1.bb<- function (theta){
  p.trip=m1
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE)) 
}

# model 2
NLL.m2<--sum(dbinom(y,size=z,prob=m2,log=TRUE))
# model 2.bb
NLL.m2.bb<- function (theta){
  p.trip=m2
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE)) 
}

# model 3
NLL.m3 = function (c){
  p.trip = m3(x,c)
  -sum(dbinom(y,size=z,prob=p.trip,log=TRUE))
}
# model 3.bb
NLL.m3.bb = function (c,theta){
  p.trip = m3(x,c)
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE))
}

# model 4
NLL.m4 = function (c0,c.exp){
  p.trip = m4(x,c0,c.exp)
  -sum(dbinom(y,size=z,prob=p.trip,log=TRUE))
}
# model 4.bb
NLL.m4.bb = function (c0,c.exp,theta){
  p.trip = m4(x,c0,c.exp)
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE))
}

# optimization
# model 1.bb 
FSP.m1.bb = mle2(NLL.m1.bb,start=list(theta=10)) 

# model 2.bb 
FSP.m2.bb = mle2(NLL.m2.bb,start=list(theta=10)) 

# model 3 
FSP.m3 = mle2(NLL.m3,start=list(c=2))
# model 3.bb 
FSP.m3.bb = mle2(NLL.m3.bb,start=list(c=2,theta=10))

# model 4 
FSP.m4 = mle2(NLL.m4,start=list(c0=2,c.exp=0))
# model 4.bb 
FSP.m4.bb = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))

logL = c(NLL.m1,-logLik(FSP.m1.bb),NLL.m2,-logLik(FSP.m2.bb),-logLik(FSP.m3),-logLik(FSP.m3.bb),
         -logLik(FSP.m4),-logLik(FSP.m4.bb))
k = c(0,1,0,1,1,2,2,3)

# AICc values
# model 1
AICc1 = -2*(-NLL.m1)+2*0 + (2*0*(0+1))/(48-0-1)
# model 1.bb
AICc1.bb = -2*(logLik(FSP.m1.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)

# model 2
AICc2 = -2*(-NLL.m2)+2*0 + (2*0*(0+1))/(48-0-1)
# model 2.bb
AICc2.bb = -2*(logLik(FSP.m2.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)

# model 3
AICc3 = -2*(logLik(FSP.m3)[1])+2*1 + (2*1*(1+1))/(48-1-1)
# model 3.bb
AICc3.bb = -2*(logLik(FSP.m3.bb)[1])+2*2 + (2*2*(2+1))/(48-2-1)

# model 4
AICc4 = -2*(logLik(FSP.m4)[1])+2*2 + (2*2*(2+1))/(48-2-1)
# model 4.bb
AICc4.bb = -2*(logLik(FSP.m4.bb)[1])+2*3 + (2*3*(3+1))/(48-3-1)

AICc = c(AICc1,AICc1.bb,AICc2,AICc2.bb,AICc3,AICc3.bb,AICc4,AICc4.bb)

# delta AICs
# calculate AIC statistics for beta-binomial set only
logL = c(logLik(FSP.m1.bb),logLik(FSP.m2.bb),logLik(FSP.m3.bb),logLik(FSP.m4.bb))
k = c(1,1,2,3)
AICc = c(AICc1.bb,AICc2.bb,AICc3.bb,AICc4.bb)
base = rep(AICc4.bb,4)
delta = AICc-base
weights = rep(0,4)
for (i in 1:4){
  weights[i]<-(exp(-0.5*delta[i])/(exp(-0.5*delta[1])+exp(-0.5*delta[2])+exp(-0.5*delta[3])+exp(-0.5*delta[4])))
}
summary = as.table(cbind(round(logL,2),k,round(AICc,2),round(delta,2),round(weights,2)))
colnames(summary) = c("logL", "K","AICc","delta AIC","Akaike weights")
rownames(summary)<-c("no cost","2-fold cost","optimized cost",
                     "cost by treatment")

detach(asex)
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Model selection probabilities

```{r}
attach(asex)

m = 10000 
delta4 = rep(0,m)

delta = matrix(nrow=m,ncol=4)

for (i in 1:m) { 
  dboot<-asex[sample(1:48,48, replace=TRUE), ]
  NLL.m1.bb = function (theta){
    x=dboot$x
    p.trip=m1
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE)) #1 parameter to estimate
  }
  NLL.m2.bb = function (theta){
    x=dboot$x
    p.trip=m2
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE)) #1 parameter to estimate
  }
  NLL.m3.bb = function (c,theta){
    p.trip = m3(x,c)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  NLL.m4.bb = function (c0,c.exp,theta){
    p.trip = m4(x,c0,c.exp)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  
  FSP.m1.bb = mle2(NLL.m1.bb,start=list(theta=10)) 
  FSP.m2.bb = mle2(NLL.m2.bb,start=list(theta=10)) 
  FSP.m3.bb = mle2(NLL.m3.bb,start=list(c=2,theta=10)) # this result is sensitive to the starting value of theta
  FSP.m4.bb = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))
  
  AICc1 = -2*(logLik(FSP.m1.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)
  AICc2 = -2*(logLik(FSP.m2.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)
  AICc3 = -2*(logLik(FSP.m3.bb)[1])+2*2 + (2*2*(2+1))/(48-2-1)
  AICc4 = -2*(logLik(FSP.m4.bb)[1])+2*3 + (2*3*(3+1))/(48-3-1)
  
  minimum = min(c(AICc1,AICc2,AICc3,AICc4))
  delta4[i] = AICc4 - minimum
  delta[i,] = c(AICc1-minimum,AICc2-minimum, AICc3-minimum,AICc4-minimum)
}

delta4 = sort(delta4,decreasing=FALSE)
delta4[m*0.95] 

detach(asex)
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Parameter estimation.

```{r}
attach(asex)

# model3
m = 10000 
cboot=rep(0,m)

for (i in 1:m) { 
  dboot<-asex[sample(1:48,48, replace=TRUE), ]
  NLL.m3.bb = function (c,theta){
    p.trip = m3(x,c)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  FSP.m3.bboot = mle2(NLL.m3.bb,start=list(c=2,theta=10)) # this result is sensitive to the starting value of theta
  cboot[i]=coef(FSP.m3.bboot)[1]
}

cboot = sort(cboot,decreasing=FALSE) 
low<-cboot[m*0.025]
high<-cboot[m*0.975] 

# model 4
m = 10000
cboot = rep(0,m)
c.expboot = rep(0,m) 

for (i in 1:m) { 
  control<-asex[sample(1:24,24, replace=TRUE), ]
  exposed<-asex[sample(25:48,24, replace=TRUE), ]
  
  dboot<-rbind(control, exposed)
  NLL.m4.bb = function (c0,c.exp,theta){
    p.trip = m4(x,c0,c.exp)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  FSP.m4.bboot = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))
  cboot[i]=coef(FSP.m4.bboot)[1]
  c.expboot[i]=coef(FSP.m4.bboot)[2]
}

cboot = sort(cboot,decreasing=FALSE) 
low<-cboot[m*0.025]
high<-cboot[m*0.975]  

c.expboot = sort(c.expboot,decreasing=FALSE)
c.explow<-c.expboot[m*0.025] 
c.exphigh<-c.expboot[m*0.975] 

detach(asex)
```
Experimental Results in the Appendix. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. GEE - Microphallus infection by sex and treatment; Table S8

```{r}
# subset by sex and treatment
fC=subset(bm2,bm2$treatment==0 & bm2$sex==0)
fE=subset(bm2,bm2$treatment==1 & bm2$sex==0)
mC=subset(bm2,bm2$treatment==0 & bm2$sex==1)
mE=subset(bm2,bm2$treatment==1 & bm2$sex==1)

# control females
fCT=tapply(fC$mic,list(fC$year,fC$replicate),length)
LfCT=melt(fCT)
names(LfCT)=c("year","replicate","total")

fCM=tapply(fC$mic,list(fC$year,fC$replicate),sum)
LfCM=melt(fCM)
names(LfCM)=c("year","replicate","mic")

Cf<-cbind(LfCT,LfCM$mic)
names(Cf)=c("year","replicate","total","mic")
healthy=Cf$total-Cf$mic
sex=rep(0,length(Cf$year))
treatment=rep("control",length(Cf$year))
tank=rep(1:24)
Cf=cbind(Cf,healthy,sex,treatment,tank)

# exposed females
fET=tapply(fE$mic,list(fE$year,fE$replicate),length)
LfET=melt(fET)
names(LfET)=c("year","replicate","total")

fEM=tapply(fE$mic,list(fE$year,fE$replicate),sum)
LfEM=melt(fEM)
names(LfEM)=c("year","replicate","mic")

Ef<-cbind(LfET,LfEM$mic)
names(Ef)=c("year","replicate","total","mic")
healthy=Ef$total-Ef$mic
sex=rep(0,length(Ef$year))
treatment=rep("exposed",length(Ef$year))
tank=rep(25:48)
Ef=cbind(Ef,healthy,sex,treatment,tank)

# control males
mCT=tapply(mC$mic,list(mC$year,mC$replicate),length)
LmCT=melt(mCT)
names(LmCT)=c("year","replicate","total")

mCM=tapply(mC$mic,list(mC$year,mC$replicate),sum)
LmCM=melt(mCM)
names(LmCM)=c("year","replicate","mic")

Cm<-cbind(LmCT,LmCM$mic)
names(Cm)=c("year","replicate","total","mic")
healthy=Cm$total-Cm$mic
sex=rep(1,length(Cm$year))
treatment=rep("control",length(Cm$year))
tank=rep(1:24)
Cm=cbind(Cm,healthy,sex,treatment,tank)

# exposed males
mET=tapply(mE$mic,list(mE$year,mE$replicate),length)
LmET=melt(mET)
names(LmET)=c("year","replicate","total")

mEM=tapply(mE$mic,list(mE$year,mE$replicate),sum)
LmEM=melt(mEM)
names(LmEM)=c("year","replicate","mic")

Em<-cbind(LmET,LmEM$mic)
names(Em)=c("year","replicate","total","mic")
healthy=Em$total-Em$mic
sex=rep(1,length(Em$year))
treatment=rep("exposed",length(Em$year))
tank=rep(25:48)
Em=cbind(Em,healthy,sex,treatment,tank)

inf<-rbind(Cf,Cm,Ef,Em)

geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(sex)+
                   treatment*factor(year)+treatment*factor(sex)+factor(year)*factor(sex)+
                   treatment*factor(year)*factor(sex), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
summary(geefit1)
anova(geefit1,test="Wald")
```

Experimental Results in the Appendix. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. Calculations

```{r}
########
# males vs females in control tanks, microphallus infection rate

Cf<-subset(bm2,bm2$treatment==0 & bm2$sex==0)
tCf=tapply(Cf$mic,list(Cf$replicate,Cf$year),length)
mCf=tapply(Cf$mic,list(Cf$replicate,Cf$year),sum)
fCf=mCf/tCf

Cm<-subset(bm2,bm2$treatment==0 & bm2$sex==1)
tCm=tapply(Cm$mic,list(Cm$replicate,Cm$year),length)
mCm=tapply(Cm$mic,list(Cm$replicate,Cm$year),sum)
fCm=mCm/tCm

mean=c(mean(fCf),mean(fCm))
se=c(sd(fCf)/sqrt(24),sd(fCm)/sqrt(24))

# sample sizes
mean=c(mean(tCf),mean(tCm))
se=c(sd(tCf)/sqrt(24),sd(tCm)/sqrt(24))

###################################################
# males vs females in exposed tanks, microphallus

Ef<-subset(bm2, bm2$treatment==1 &bm2$sex==0)
tEf=tapply(Ef$mic,list(Ef$replicate,Ef$year),length)
mEf=tapply(Ef$mic,list(Ef$replicate,Ef$year),sum)
fEf=mEf/tEf

Em<-subset(bm2,bm2$treatment==1 & bm2$sex==1)
tEm=tapply(Em$mic,list(Em$replicate,Em$year),length)
mEm=tapply(Em$mic,list(Em$replicate,Em$year),sum)
fEm=mEm/tEm

mean=c(mean(fEf),mean(fEm))
se=c(sd(fEf)/sqrt(24),sd(fEm)/sqrt(24))

# sample sizes
mean=c(mean(tEf),mean(tEm))
se=c(sd(tEf)/sqrt(24),sd(tEm)/sqrt(24))
```

Experimental Results in the Appendix. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. Figure S6

```{r}
fC=subset(bm2,bm2$treatment==0 & bm2$sex==0)
fE=subset(bm2,bm2$treatment==1 & bm2$sex==0)
mC=subset(bm2,bm2$treatment==0 & bm2$sex==1)
mE=subset(bm2,bm2$treatment==1 & bm2$sex==1)

# now divide each subset by tank and year
# control females
fCT=tapply(fC$mic,list(fC$year,fC$replicate),length)
LfCT=melt(fCT)
names(LfCT)=c("year","replicate","total")

fCM=tapply(fC$mic,list(fC$year,fC$replicate),sum)
LfCM=melt(fCM)
names(LfCM)=c("year","replicate","mic")

Cf<-cbind(LfCT,LfCM$mic)
names(Cf)=c("year","replicate","total","mic")
healthy=Cf$total-Cf$mic
sex=rep(0,length(Cf$year))
treatment=rep("control",length(Cf$year))
Cf=cbind(Cf,healthy,sex,treatment)

# exposed females
fET=tapply(fE$mic,list(fE$year,fE$replicate),length)
LfET=melt(fET)
names(LfET)=c("year","replicate","total")

fEM=tapply(fE$mic,list(fE$year,fE$replicate),sum)
LfEM=melt(fEM)
names(LfEM)=c("year","replicate","mic")

Ef<-cbind(LfET,LfEM$mic)
names(Ef)=c("year","replicate","total","mic")
healthy=Ef$total-Ef$mic
sex=rep(0,length(Ef$year))
treatment=rep("exposed",length(Ef$year))
Ef=cbind(Ef,healthy,sex,treatment)

# control males
mCT=tapply(mC$mic,list(mC$year,mC$replicate),length)
LmCT=melt(mCT)
names(LmCT)=c("year","replicate","total")

mCM=tapply(mC$mic,list(mC$year,mC$replicate),sum)
LmCM=melt(mCM)
names(LmCM)=c("year","replicate","mic")

Cm<-cbind(LmCT,LmCM$mic)
names(Cm)=c("year","replicate","total","mic")
healthy=Cm$total-Cm$mic
sex=rep(1,length(Cm$year))
treatment=rep("control",length(Cm$year))
Cm=cbind(Cm,healthy,sex,treatment)

# exposed males
mET=tapply(mE$mic,list(mE$year,mE$replicate),length)
LmET=melt(mET)
names(LmET)=c("year","replicate","total")

mEM=tapply(mE$mic,list(mE$year,mE$replicate),sum)
LmEM=melt(mEM)
names(LmEM)=c("year","replicate","mic")

Em<-cbind(LmET,LmEM$mic)
names(Em)=c("year","replicate","total","mic")
healthy=Em$total-Em$mic
sex=rep(1,length(Em$year))
treatment=rep("exposed",length(Em$year))
Em=cbind(Em,healthy,sex,treatment)

# now bring them all together
inf<-rbind(Cf,Cm,Ef,Em)

freq=inf$mic/inf$total
inf=cbind(inf,freq)

# plot
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(inf$freq~inf$sex*inf$treatment,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=2,cex.axis=1.5,names=c("","","",""),
        xlab="",outcex=1.5,
        col=c("#ca0020","#f4a582"))
abline(v=2.5,lty=3)
text(1.5,0.9,"Control",cex=2)
text(3.5,0.9,"Exposed",cex=2)

# sample siz
m<-subset(inf,inf$sex==1)
mean(m$total)
sd(m$total)/sqrt(48)

f<-subset(inf,inf$sex==0)
mean(f$total)
sd(f$total)/sqrt(48)
```
Experimental Results in the Appendix. Comparison of male frequency (sex ratio) in experimental mesocosms, 2012-2015.Paragraphs 8+9 of Appendix

```{r}
# subset by treatment
C=subset(bm2,bm2$treatment==0)
E=subset(bm2,bm2$treatment==1)

# control tanks
CT=tapply(C$sex,list(C$year,C$replicate),length)
LCT=melt(CT)
names(LCT)=c("year","replicate","total")

CM=tapply(C$sex,list(C$year,C$replicate),sum)
LCM=melt(CM)
names(LCM)=c("year","replicate","male")

control<-cbind(LCT,LCM$male)
names(control)=c("year","replicate","total","male")
female=control$total-control$male
treatment=rep("control",length(control$year))
control=cbind(control,female,treatment)

# exposed tanks
ET=tapply(E$sex,list(E$year,E$replicate),length)
LET=melt(ET)
names(LET)=c("year","replicate","total")

EM=tapply(E$sex,list(E$year,E$replicate),sum)
LEM=melt(EM)
names(LEM)=c("year","replicate","male")

exposed<-cbind(LET,LEM$male)
names(exposed)=c("year","replicate","total","male")
female=exposed$total-exposed$male
treatment=rep("exposed",length(exposed$year))
exposed=cbind(exposed,female,treatment)

# frequencies
cfreq=control$male/control$total
efreq=exposed$male/exposed$total

mean(cfreq)
sd(cfreq)/sqrt(24)

mean(efreq)
sd(efreq)/sqrt(24)

ad.test(cfreq) 
ad.test(efreq) 
# paired t-test
t.test(cfreq,efreq,paired=TRUE) 

# non-parametric
wilcox.test(cfreq,efreq,paired=TRUE)
```
Experimental Results in the Appendix. Comparison of triploid frequency in experimental mesocosms, 2012-2015.Paragraphs 8+9 of Appendix

```{r}
# subset by ploidy and treatment
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# control asexuals
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed asexuals
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control sexuals
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed sexuals
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

LCT=cbind(LaCT,LsCT$diploid)
treatment=rep("control",length(LCT$triploid))
LCT=cbind(LCT,treatment)
names(LCT)=c("year","replicate","triploid","diploid","treatment")

LET=cbind(LaET,LsET$diploid)
treatment=rep("exposed",length(LET$triploid))
LET=cbind(LET,treatment)
names(LET)=c("year","replicate","triploid","diploid","treatment")

cfreq3=LCT$triploid/(LCT$triploid+LCT$diploid)
efreq3=LET$triploid/(LET$triploid+LET$diploid)

mean(cfreq3)
mean(efreq3)
mean(cfreq3-efreq3)

ad.test(cfreq3)
ad.test(efreq3)
t.test(cfreq3,efreq3,paired=T) 
wilcox.test(cfreq3,efreq3,paired=TRUE) 
```
Experimental Results in the Appendix. Comparison of males and triploid frequency in experimental mesocosms, 2012-2015.Paragraphs 8+9 of Appendix. Calculations

```{r}
# male frequency/sex ratio
# subset by treatment
C=subset(bm2,bm2$treatment==0)
E=subset(bm2,bm2$treatment==1)

# control tanks
CT=tapply(C$sex,list(C$year,C$replicate),length)
LCT=melt(CT)
names(LCT)=c("year","replicate","total")

CM=tapply(C$sex,list(C$year,C$replicate),sum)
LCM=melt(CM)
names(LCM)=c("year","replicate","male")

control<-cbind(LCT,LCM$male)
names(control)=c("year","replicate","total","male")
female=control$total-control$male
treatment=rep("control",length(control$year))
control=cbind(control,female,treatment)

# exposed tanks
ET=tapply(E$sex,list(E$year,E$replicate),length)
LET=melt(ET)
names(LET)=c("year","replicate","total")

EM=tapply(E$sex,list(E$year,E$replicate),sum)
LEM=melt(EM)
names(LEM)=c("year","replicate","male")

exposed<-cbind(LET,LEM$male)
names(exposed)=c("year","replicate","total","male")
female=exposed$total-exposed$male
treatment=rep("exposed",length(exposed$year))
exposed=cbind(exposed,female,treatment)

cfreq=control$male/control$total
efreq=exposed$male/exposed$total

mean=c(mean(cfreq),mean(efreq))
se=c(sd(cfreq)/sqrt(length(cfreq)),sd(efreq/sqrt(length(efreq))))

# sample sizes
mean=c(mean(control$total),mean(exposed$total))
se=c(sd(control$total)/sqrt(length(control$total)),sd(exposed$total)/sqrt(length(exposed$total)))

######
# triploid frequency
# subset by ploidy and treatment
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# get lengths by treatment and replicate
# control asexuals
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed asexuals
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control sexuals
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed sexuals
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

LCT=cbind(LaCT,LsCT$diploid)
treatment=rep("control",length(LCT$triploid))
LCT=cbind(LCT,treatment)
names(LCT)=c("year","replicate","triploid","diploid","treatment")

LET=cbind(LaET,LsET$diploid)
treatment=rep("exposed",length(LET$triploid))
LET=cbind(LET,treatment)
names(LET)=c("year","replicate","triploid","diploid","treatment")

cfreq3=LCT$triploid/(LCT$triploid+LCT$diploid)
efreq3=LET$triploid/(LET$triploid+LET$diploid)

mean=c(mean(cfreq3),mean(efreq3))
se=c(sd(cfreq3)/sqrt(length(cfreq3)),sd(efreq3/sqrt(length(efreq3))))

# sample sizes
mean(LCT$triploid+LCT$diploid)
mean(LET$triploid+LET$diploid)

sd(LCT$triploid+LCT$diploid)/sqrt(length(LCT$triploid))
sd(LET$triploid+LET$diploid)/sqrt(length(LET$triploid))

```

Experimental Results in the Appendix.Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. By year. Figure S3

```{r}
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# now divide each subset by tank and year
# control asexuals
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
Ca=cbind(Ca,healthy,ploidy,treatment)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
Ea=cbind(Ea,healthy,ploidy,treatment)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
Cs=cbind(Cs,healthy,ploidy,treatment)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
Es=cbind(Es,healthy,ploidy,treatment)

# now bring them all together
inf<-rbind(Ca,Cs,Ea,Es)
freq=inf$mic/inf$total
inf=cbind(inf,freq)

# plotting
par(mar=c(4,4,4,4))
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(inf$freq~inf$ploidy*inf$treatment*inf$year,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=2,cex.axis=1.5,names=c("Sexual","Asexual","Sexual","Asexual",
                                   "Sexual","Asexual","Sexual","Asexual",
                                   "Sexual","Asexual","Sexual","Asexual",
                                   "Sexual","Asexual","Sexual","Asexual"),
        xlab="",
        col=c("#ca0020","#0571b0"),outcex=1.5)
abline(v=2.5,lty=3)
abline(v=4.5)
abline(v=6.5,lty=3)
abline(v=8.5)
abline(v=10.5,lty=3)
abline(v=12.5)
abline(v=14.5,lty=3)
```

Experimental Results in the Appendix.  Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. By year. Figure 2B

```{r}
#babies
babb<-subset(bab,bab$cohort=="baby")

aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfbabies=cbind(T,freq,sum)
cohort=rep("baby",length(Tfbabies$treatment))
Tfbabies=cbind(Tfbabies,cohort)

# adults
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tf=rbind(Tfadults,Tfbabies)
Tf$treatment<-factor(Tf$treatment, levels=c("control","exposed"))
Tfadults$treatment<-factor(Tfadults$treatment, levels=c("control","exposed"))
Tfbabies$treatment<-factor(Tfbabies$treatment, levels=c("control","exposed"))

# plot
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(Tf$freq~Tf$treatment*Tf$cohort*Tf$year,
        ylim=c(0,1),
        lwd=2,cex.axis=1.5,names=rep(c("Control","Exposed"),8),
        col=c("#bdbdbd","#636363"),outcex=1.5)
abline(v=2.5,lty=3)
abline(v=4.5,lty=1)
abline(v=6.5,lty=3)
abline(v=8.5,lty=1)
abline(v=10.5,lty=3)
abline(v=12.5,lty=1)
abline(v=14.5,lty=3)

```

