---
title: "Gibson2018_analysis-codes_experimental-data"
author: "Amanda Gibson"
date: "June 18, 2018"
output: pdf_document
---

For paper Periodic, parasite-mediated selection for and against sex; Gibson, Delph, Vergara, and Lively 2018

Packages used
```{r}
# PACKAGES
library(reshape)
library(matrixStats)
library(Hmisc)
library(aod)
library(geepack)
library(bbmle)
library(emdbook)
library(nortest)
options(digits=4)
```

Data sets
```{r}
# IMPORTING DATA
# experimental mesocosms; adult females
ba0<-read.csv("Bins_adults.csv")
ba<-subset(ba0,ba0$sex==0 & ba0$ploidy>0)

# experimental mesocosms; adults females + male
bm<-read.csv("Bins_adults_withmales.csv")
bm<-subset(bm,bm$ploidy>0)
bm2<-subset(bm,bm$ploidy==2)

# experimental mesocosms; babies
bb0<-read.csv("Bins_babies.csv")
bb<-subset(bb0,bb0$ploidy>0)

# experimental mesocosms; adults+babies
bab<-read.csv("Bins_adults-babies.csv")
bab<-subset(bab,bab$ploidy>0)

```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - Microphallus infection rate in sexual and asexual snails in experimental replicates. Females. Table B4A
```{r}
# MANIPULATION AND CALCULATIONS
# subset by ploidy and treatment
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# group by tank and year
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

# STATISTICAL MODELS
geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")

# testing three-way interaction
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)

geefit2<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")

#testing treatment* ploidy
wald.test(b = coef(geefit2), Sigma = vcov(geefit2), Terms = 10)

geefit3<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
# final model geefit3

#TABLE B4A
anova(geefit3,test="LRT")
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - All castrating trematode infection rate in sexual and asexual snails in experimental replicates. Females. Table B4B

```{r}
# MANIPULATION AND CALCULATIONS

# control asexuals
aCT=tapply(aC$castrated,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$castrated,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","cas")

Ca<-cbind(LaCT,LaCM$cas)
names(Ca)=c("year","replicate","total","cas")
healthy=Ca$total-Ca$cas
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$castrated,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$castrated,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","cas")

Ea<-cbind(LaET,LaEM$cas)
names(Ea)=c("year","replicate","total","cas")
healthy=Ea$total-Ea$cas
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$castrated,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$castrated,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","cas")

Cs<-cbind(LsCT,LsCM$cas)
names(Cs)=c("year","replicate","total","cas")
healthy=Cs$total-Cs$cas
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$castrated,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$castrated,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","cas")

Es<-cbind(LsET,LsEM$cas)
names(Es)=c("year","replicate","total","cas")
healthy=Es$total-Es$cas
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

# STATISTICAL MODELS
geefit1<-geeglm( cbind(cas,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")

# testing three-way interaction
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)

geefit2<-geeglm( cbind(cas,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
# final model geefit2

# TABLE B4B
anova(geefit2,test="LRT")

```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. GEE - Microphallus infection rate in sexual and asexual snails in experimental replicates. Females + Males. MALES INCLUDED

```{r}
# MANIPULATION AND CALCULATIONS

# subset by ploidy and treatment
aC=subset(bm,bm$treatment==0 & bm$ploidy==3)
aE=subset(bm,bm$treatment==1 & bm$ploidy==3)
sC=subset(bm,bm$treatment==0 & bm$ploidy==2)
sE=subset(bm,bm$treatment==1 & bm$ploidy==2)

# control asexuals
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
tank=rep(1:24)
Ca=cbind(Ca,healthy,ploidy,treatment,tank)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
tank=rep(25:48)
Ea=cbind(Ea,healthy,ploidy,treatment,tank)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
tank=rep(1:24)
Cs=cbind(Cs,healthy,ploidy,treatment,tank)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
tank=rep(25:48)
Es=cbind(Es,healthy,ploidy,treatment,tank)

inf<-rbind(Ca,Cs,Ea,Es)

# STATISTICAL MODELS
geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(ploidy)+
                   treatment*factor(year)+treatment*factor(ploidy)+factor(year)*factor(ploidy)+
                   treatment*factor(year)*factor(ploidy), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")
# testing three-way interaction
wald.test(b = coef(geefit1), Sigma = vcov(geefit1), Terms = 14:16)
# final model geefit2

# MODEL NOT SHOWN IN TEXT - RESULTS NOTED IN APPENDIX A
anova(geefit1,test="LRT")

```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Calculations

```{r}
# EXPERIMENTAL EXPOSURES - INCREASE IN MICROPHALLUS INFECTION RATE ACROSS TREATMENTS

# MANIPULATION AND CALCULATIONS
# increase in infection from control to exposed tanks#
# control tanks
# all females, yes/no mic by tank, year
C<-subset(ba,ba$treatment==0)
tC=tapply(C$mic,list(C$replicate,C$year),length)
mC=tapply(C$mic,list(C$replicate,C$year),sum)
fC=mC/tC

# exposed tanks
# all females, yes/no mic by tank, year
E<-subset(ba,ba$treatment==1)
tE=tapply(E$mic,list(E$replicate,E$year),length)
mE=tapply(E$mic,list(E$replicate,E$year),sum)
fE=mE/tE

m=c(mean(fC),mean(fE))
se=c(sd(fC)/sqrt(24),sd(fE)/sqrt(24))

# SUMMARY OF CHANGE IN MICROPHALLUS INFECTION RATE ACROSS TREATMENTS
t1<-cbind(m,se)
colnames(t1)=c("mean infection rate with microphallus","se of mean")
rownames(t1)=c("control","exposed")
t1

print("fold-change")
mean(fE)/mean(fC)
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Calculations

```{r}
# SEXUAL V ASEXUAL INFECTION RATE - CONTROL TANKS

# MANIPULATION AND CALCULATIONS
# differential infection in control tanks#
Ca<-subset(ba, ba$treatment==0 &ba$ploidy==3)
tCa=tapply(Ca$mic,list(Ca$replicate,Ca$year),length)
mCa=tapply(Ca$mic,list(Ca$replicate,Ca$year),sum)
fCa=mCa/tCa

Cs<-subset(ba,ba$treatment==0 & ba$ploidy==2)
tCs=tapply(Cs$mic,list(Cs$replicate,Cs$year),length)
mCs=tapply(Cs$mic,list(Cs$replicate,Cs$year),sum)
fCs=mCs/tCs

m1=mean(fCa)
m2=mean(fCs)
se1=sd(fCa)/sqrt(24)
se2=sd(fCs)/sqrt(24)

fold<-mean(fCa)/mean(fCs) # fold increase
se_fold=fold*sqrt(((se1/m1)^2)+((se2/m2)^2))

# SUMMARY OF MICROPHALLUS INFECTION RATE BY PLOIDY - CONTROL TANKS
t2<-matrix(c(m1,m2,se1,se2),nrow=2)
colnames(t2)=c("mean infection rate with microphallus","se of mean")
rownames(t2)=c("asexual","sexual")
t2

print("fold-change")
fold
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Calculations

```{r}
## SEXUAL V ASEXUAL INFECTION RATE - EXPOSED TANKS

# MANIPULATION AND CALCULATIONS
# differential infection in exposed tanks#
Ea<-subset(ba,ba$treatment==1 &ba$ploidy==3)
tEa=tapply(Ea$mic,list(Ea$replicate,Ea$year),length)
mEa=tapply(Ea$mic,list(Ea$replicate,Ea$year),sum)
fEa=mEa/tEa

Es<-subset(ba,ba$treatment==1 & ba$ploidy==2)
tEs=tapply(Es$mic,list(Es$replicate,Es$year),length)
mEs=tapply(Es$mic,list(Es$replicate,Es$year),sum)
fEs=mEs/tEs

m1=mean(fEa)
m2=mean(fEs)
se1=sd(fEa)/sqrt(24)
se2=sd(fEs)/sqrt(24)

fold<-mean(fEa)/mean(fEs) # fold increase
se_fold=fold*sqrt(((se1/m1)^2)+((se2/m2)^2))

# SUMMARY OF MICROPHALLUS INFECTION RATE BY PLOIDY - EXPOSED TANKS
t3<-matrix(c(m1,m2,se1,se2),nrow=2)
colnames(t3)=c("mean infection rate with microphallus","se of mean")
rownames(t3)=c("asexual","sexual")
t3

print("fold-change")
fold
```

Paragraphs 8-9 of the Results section. Comparison of parasite infectivity against local sexual and asexual snails; 2012-2015. Figure 2A & B3
```{r}
# FIGURES 2A AND B3

# MANIPULATION AND CALCULATIONS
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# now divide each subset by tank and year
# control asexuals
aCT=tapply(aC$mic,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","total")

aCM=tapply(aC$mic,list(aC$year,aC$replicate),sum)
LaCM=melt(aCM)
names(LaCM)=c("year","replicate","mic")

Ca<-cbind(LaCT,LaCM$mic)
names(Ca)=c("year","replicate","total","mic")
healthy=Ca$total-Ca$mic
ploidy=rep(3,length(Ca$year))
treatment=rep("control",length(Ca$year))
Ca=cbind(Ca,healthy,ploidy,treatment)

# exposed asexuals
aET=tapply(aE$mic,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","total")

aEM=tapply(aE$mic,list(aE$year,aE$replicate),sum)
LaEM=melt(aEM)
names(LaEM)=c("year","replicate","mic")

Ea<-cbind(LaET,LaEM$mic)
names(Ea)=c("year","replicate","total","mic")
healthy=Ea$total-Ea$mic
ploidy=rep(3,length(Ea$year))
treatment=rep("exposed",length(Ea$year))
Ea=cbind(Ea,healthy,ploidy,treatment)

# control sexuals
sCT=tapply(sC$mic,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","total")

sCM=tapply(sC$mic,list(sC$year,sC$replicate),sum)
LsCM=melt(sCM)
names(LsCM)=c("year","replicate","mic")

Cs<-cbind(LsCT,LsCM$mic)
names(Cs)=c("year","replicate","total","mic")
healthy=Cs$total-Cs$mic
ploidy=rep(2,length(Cs$year))
treatment=rep("control",length(Cs$year))
Cs=cbind(Cs,healthy,ploidy,treatment)

# exposed sexuals
sET=tapply(sE$mic,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","total")

sEM=tapply(sE$mic,list(sE$year,sE$replicate),sum)
LsEM=melt(sEM)
names(LsEM)=c("year","replicate","mic")

Es<-cbind(LsET,LsEM$mic)
names(Es)=c("year","replicate","total","mic")
healthy=Es$total-Es$mic
ploidy=rep(2,length(Es$year))
treatment=rep("exposed",length(Es$year))
Es=cbind(Es,healthy,ploidy,treatment)

# now bring them all together
inf<-rbind(Ca,Cs,Ea,Es)
freq=inf$mic/inf$total
inf=cbind(inf,freq)

# FIGURE 2A
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(inf$freq~inf$ploidy*inf$treatment,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=2,cex.axis=1,names=c("Sexual","Asexual","Sexual","Asexual"),
        xlab="",
        col=c("#bdbdbd","#525252"),outcex=1.5)
abline(v=2.5,lty=3)
text(1.5,0.9,"Control",cex=1.5)
text(3.5,0.9,"Exposed",cex=1.5)

# SAMPLE SIZES
trip<-inf[inf$ploidy==3,]
m1<-mean(trip$total)
se1<-sd(trip$total)/sqrt(length(trip$total))

dip<-inf[inf$ploidy==2,]
m2<-mean(dip$total)
se2<-sd(dip$total)/sqrt(length(dip$total))

# SUMMARY SAMPLE SIZES FIG 2A
t4<-matrix(c(m1,m2,se1,se2),nrow=2)
colnames(t4)=c("mean females sampled","se of mean")
rownames(t4)=c("asexual","sexual")
t4

#FIGURE B3
# FIGURE 2A
par(tck=0.01)
par(las=1)
par(lwd=1)
par(col="gray30")
boxplot(inf$freq~inf$ploidy*inf$treatment*inf$year,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=1,cex.axis=1,
        xlab="",xaxt="n",
        col=c("#bdbdbd","#525252"),outcex=1.5)
axis(1, at=seq(1,16,1), labels=FALSE)

lab=c("Sexual","Asexual","Sexual","Asexual",
      "Sexual","Asexual","Sexual","Asexual",
      "Sexual","Asexual","Sexual","Asexual",
      "Sexual","Asexual","Sexual","Asexual")
text(x=seq(1,16,1), y=par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]),
     labels=lab, srt=45, adj=1, xpd=TRUE,cex=1,col="black")

abline(v=2.5,lty=3)
abline(v=4.5)
abline(v=6.5,lty=3)
abline(v=8.5)
abline(v=10.5,lty=3)
abline(v=12.5)
abline(v=14.5,lty=3)

```
Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. quasi-GLM - proportion of offspring asexual in control and exposed mesocosms. Females, all years. Table B5A

```{r}

# MANIPULATION AND CALCULATIONS 
aC=subset(bb,bb$treatment==0 & bb$ploidy==3)
aE=subset(bb,bb$treatment==1 & bb$ploidy==3)
sC=subset(bb,bb$treatment==0 & bb$ploidy==2)
sE=subset(bb,bb$treatment==1 & bb$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)

# STATISTICAL MODELS
lrfit<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
            family = binomial,data=T)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/40 

# quasi
# TABLE B5A
lrfitq<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
             family = quasibinomial,data=T)

# testing treatment*year interaction
lrfitq2<-glm( cbind(triploid,diploid) ~ treatment+factor(year), 
              family = quasibinomial,data=T)
anova(lrfitq,lrfitq2,test="F")

anova(lrfitq2,test="F")
```
Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. quasi-GLM - proportion of offspring asexual in control and exposed mesocosms. Females, 2013-2015 Table B5B

```{r}
Tlat<-subset(T,T$year!=2012)
lrfit<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
            family = binomial,data=Tlat)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/30

# quasi
# TABLE B5B
lrfitq<-glm( cbind(triploid,diploid) ~ treatment*factor(year), 
             family = quasibinomial,data=Tlat)

# testing interaction
lrfitq2<-glm( cbind(triploid,diploid) ~ treatment+factor(year), 
              family = quasibinomial,data=Tlat)
anova(lrfitq,lrfitq2,test="F")

anova(lrfitq2,test="F")
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Calculations

```{r}
# FREQUENCY OF ASEXUALS IN ADULTS 2012-2015

# MANIPULATION AND CALCULATIONS
# adults
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tfa=mean(Tfadults$freq[1:48])
Tfa_se=sd(Tfadults$freq[1:48])/sqrt(48)

# SUMMARY FREQUENCY ASEXUALS IN ADULTS, 2012-2015
t5<-rbind(Tfa,Tfa_se)
rownames(t5)=c("mean","se")
colnames(t5)=c("frequency of asexuals in adult generation")
t5
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2013-2015. Calculations - reported in Table B5B
```{r}
# FREQUENCY OF ASEXUALS IN ADULTS 2013-2015

# MANIPULATIONS AND CALCULATIONS
Tf2<-subset(Tfadults,Tfadults$year>2012)
mean(Tf2$freq)
sd(Tf2$freq)/sqrt(36)

m<-mean(Tf2$freq)
sd<-sd(Tf2$freq)
se<-sd/sqrt(length(Tf2$freq))

# SUMMARY FREQUENCY ASEXUALS IN ADULTS, 2013-2015
# TABLE B5B
t6<-rbind(m,se)
rownames(t6)=c("mean","se")
colnames(t6)=c("frequency of asexuals in adult generation")
t6
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Calculations

```{r}
# FREQUENCY OF ASEXUALS IN OFFSPRING GENERATION 2012-2015

# MANIPULATION AND CALCULATIONS
#fraction asexual babies in control v exposed
aC=subset(bb,bb$treatment==0 & bb$ploidy==3)
aE=subset(bb,bb$treatment==1 & bb$ploidy==3)
sC=subset(bb,bb$treatment==0 & bb$ploidy==2)
sE=subset(bb,bb$treatment==1 & bb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tf=cbind(T,freq,sum)

m<-tapply(Tf$freq,list(Tf$treatment),mean)
sd<-tapply(Tf$freq,list(Tf$treatment),sd)
se<-sd/sqrt(length(Tf$treatment)/2)

# SUMMARY OF ASEXUAL FREQUENCY IN OFFSPRING, 2012-2015
t7<-cbind(m,se)
colnames(t7)=c("mean frequency asexuals in offspring","se of mean")
t7
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2013-2015. Calculations - presented in Table B5B

```{r}
# # FREQUENCY OF ASEXUALS IN OFFSPRING GENERATION 2013-2015

# MANIPULATION AND CALCULATIONS
Tf2<-subset(Tf,Tf$year>2012)

m2<-tapply(Tf2$freq,list(Tf2$treatment),mean)
sd<-tapply(Tf2$freq,list(Tf2$treatment),sd)
se<-sd/sqrt(length(Tf2$treatment)/2)

# SUMMARY OF ASEXUAL FREQUENCY IN OFFSPRING, 2013-2015
# TABLE B5B
t8<-cbind(m2,se)
colnames(t8)=c("mean frequency asexuals in offspring","se of mean")
t8
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Calculations


```{r}
# FOLD-CHANGE IN ASEXUAL FREQUENCY BY TREATMENT 2012-2015

# MANIPULATION AND CALCULATIONS
babb<-subset(bab,bab$cohort=="baby")
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfbabies=cbind(T,freq,sum)
cohort=rep("baby",length(Tfbabies$treatment))
Tfbabies=cbind(Tfbabies,cohort)

baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tf=rbind(Tfadults,Tfbabies)
Tf$treatment<-factor(Tf$treatment, levels=c("control","exposed"))
Tfadults$treatment<-factor(Tfadults$treatment, levels=c("control","exposed"))
Tfbabies$treatment<-factor(Tfbabies$treatment, levels=c("control","exposed"))

#means
Tfa=mean(Tf$freq[1:48])
Tfa_se=sd(Tf$freq[1:48])/sqrt(48)

TfbE=mean(Tf$freq[49:72])
TfbE_se=sd(Tf$freq[49:72])/sqrt(24)

TfbC=mean(Tf$freq[73:96])
TfbC_se=sd(Tf$freq[73:96])/sqrt(24)

#fold changes
foldC=TfbC/Tfa
se_foldC=foldC*sqrt(((Tfa_se/Tfa)^2)+((TfbC_se/TfbC)^2))

foldE=TfbE/Tfa
se_foldE=foldE*sqrt(((Tfa_se/Tfa)^2)+((TfbE_se/TfbE)^2))

#SUMMARY FOLD-CHANGE IN ASEXUAL FREQUENCY 2012-2015
t9<-matrix(c(foldC,foldE,se_foldC,se_foldE),nrow=2)
rownames(t9)=c("control","exposed")
colnames(t9)=c("fold-change in asexual frequency","se of fold-change")
t9
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2013-2015. Calculations - presented in Table B5B
```{r}
# FOLD-CHANGE IN ASEXUAL FREQUENCY BY TREATMENT 2013-2015

# MANIPULATION AND CALCULATIONS
Tf2<-subset(Tf,Tf$year>2012)

#means
Tfa=mean(Tf2$freq[1:36])
Tfa_se=sd(Tf2$freq[1:36])/sqrt(36)

TfbE=mean(Tf2$freq[37:54])
TfbE_se=sd(Tf2$freq[37:54])/sqrt(18)

TfbC=mean(Tf2$freq[55:72])
TfbC_se=sd(Tf2$freq[55:72])/sqrt(18)

#fold changes
foldC=TfbC/Tfa
se_foldC=foldC*sqrt(((Tfa_se/Tfa)^2)+((TfbC_se/TfbC)^2))

foldE=TfbE/Tfa
se_foldE=foldE*sqrt(((Tfa_se/Tfa)^2)+((TfbE_se/TfbE)^2))

#SUMMARY FOLD-CHANGE IN ASEXUAL FREQUENCY 2013-2015
# TABLE B5B
t10<-matrix(c(foldC,foldE,se_foldC,se_foldE),nrow=2)
rownames(t10)=c("control","exposed")
colnames(t10)=c("fold-change in asexual frequency","se of fold-change")
t10
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Calculations - Methods section "Experimental test of parasite-mediated selection/Data collection""

```{r}
# AMBIGUOUS DNA CONTENT 

# MANIPULATION AND CALCULATIONS
# OFFSPRING
d<-subset(bb0,bb0$ploidy!="NA")
l<-tapply(d$ploidy,list(d$year,d$tank),length)

#zero
d2<-subset(bb0,bb0$ploidy==0)
l2<-tapply(d2$ploidy,list(d2$year,d2$tank),length)
l2[is.na(l2)] <- 0

print("mean proportion of analyzed offspring excluded due to ambiguous DNA content in flow cytometry")
mean(l2/l)
print("standard error of mean")
sd(l2/l)/sqrt(48) # standard error of mean 

# ADULTS
d<-subset(ba0,ba0$ploidy!="NA")
l<-tapply(d$ploidy,list(d$year,d$tank),length)

#zero
d2<-subset(ba0,ba0$ploidy==0)
l2<-tapply(d2$ploidy,list(d2$year,d2$tank),length)
l2[is.na(l2)] <- 0

print("mean proportion of analyzed adults excluded due to ambiguous DNA content in flow cytometry")
mean(l2/l)
print("standard error of mean")
sd(l2/l)/sqrt(48) # standard error of mean 
```

Paragraph 11 of the Results section. Comparison of asexual fitness in presence and absence of parasite selection; 2012-2015. Figures 2B & B4

```{r}
# FIGURES 2B AND B4

# MANIPULATION AND CALCULATIONS
babb<-subset(bab,bab$cohort=="baby")
# subset by ploidy and treatment
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfbabies=cbind(T,freq,sum)
cohort=rep("baby",length(Tfbabies$treatment))
Tfbabies=cbind(Tfbabies,cohort)

# now adults!
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba,baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids first
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge them
treatment=rep("exposed",length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep("control",length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
sum=T$triploid+T$diploid
Tfadults=cbind(T,freq,sum)
cohort=rep("adult",length(Tfadults$treatment))
Tfadults=cbind(Tfadults,cohort)

Tf=rbind(Tfadults,Tfbabies)
Tf$treatment<-factor(Tf$treatment, levels=c("control","exposed"))
Tfadults$treatment<-factor(Tfadults$treatment, levels=c("control","exposed"))
Tfbabies$treatment<-factor(Tfbabies$treatment, levels=c("control","exposed"))

# FIGURE 2B
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(Tf$freq~Tf$treatment*Tf$cohort,
        ylim=c(0,1),
        lwd=2,cex.axis=1,names=c("Control","Exposed","Control","Exposed"),
        col=c("#f0f0f0","#969696"),outcex=1.5)
abline(v=2.5,lty=3)

# SAMPLE SIZES
adult<-Tf[Tf$cohort=="adult",]
m1<-mean(adult$sum)
se1<-sd(adult$sum)/sqrt(length(adult$sum))

off<-Tf[Tf$cohort=="baby",]
m2<-mean(off$sum)
se2<-sd(off$sum)/sqrt(length(off$sum))

# SUMMARY SAMPLE SIZES FIG 2B
t11<-matrix(c(m1,m2,se1,se2),nrow=2)
colnames(t11)=c("mean number sampled","se of mean")
rownames(t11)=c("adults","offspring")
t11

#FIGURE 4B
par(las=1)
par(lwd=1)
par(col="gray30")
par(tck=0.01)
boxplot(Tf$freq~Tf$treatment*Tf$cohort*Tf$year,
        ylim=c(0,1),
        lwd=1,cex.axis=1,xaxt="n",
        col=c("#f0f0f0","#969696"),outcex=1.5)

axis(1, at=seq(1,16,1), labels=FALSE)

lab=c(rep(c("Control","Exposed"),8))
text(x=seq(1,16,1), y=par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]),
     labels=lab, srt=45, adj=1, xpd=TRUE,cex=1,col="black")

abline(v=2.5,lty=3)
abline(v=4.5,lty=1)
abline(v=6.5,lty=3)
abline(v=8.5,lty=1)
abline(v=10.5,lty=3)
abline(v=12.5,lty=1)
abline(v=14.5,lty=3)
```

Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Prepping data for model fit

```{r}
# MANIPULATION AND CALCULATIONS

babb<-subset(bab,bab$cohort=="baby")
# subset by ploidy and treatment
aC=subset(babb,babb$treatment==0 & babb$ploidy==3)
aE=subset(babb,babb$treatment==1 & babb$ploidy==3)
sC=subset(babb,babb$treatment==0 & babb$ploidy==2)
sE=subset(babb,babb$treatment==1 & babb$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge
treatment=rep(2,length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep(1,length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
sum=T$triploid+T$diploid
Tfbabies=data.frame(cbind(T$year,T$replicate,T$treatment,T$triploid,sum))
names(Tfbabies)=c("year","rep","treatment","y","z")

# adults
baba<-subset(bab,bab$cohort=="adult")
# subset by ploidy and treatment
aC=subset(baba, baba$treatment==0 & baba$ploidy==3)
aE=subset(baba,baba$treatment==1 & baba$ploidy==3)
sC=subset(baba,baba$treatment==0 & baba$ploidy==2)
sE=subset(baba,baba$treatment==1 & baba$ploidy==2)

# control triploids
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed triploids
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control diiploids
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed diploids
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

#merge 
treatment=rep(1,length(LaET$triploid))
ET=cbind(LsET,LaET$triploid,treatment)
names(ET)=c("year","replicate","diploid","triploid","treatment")

treatment=rep(0,length(LaCT$triploid))
CT=cbind(LsCT,LaCT$triploid,treatment)
names(CT)=c("year","replicate","diploid","triploid","treatment")

T=rbind(ET,CT)
freq=T$triploid/(T$triploid+T$diploid)
Tfadults=cbind(T,freq)

asex=cbind(Tfbabies,Tfadults$freq)
names(asex)=c("year","rep","treatment","y","z","x")

asex$year<-as.factor(asex$year)
asex$treatment<-as.factor(asex$treatment)
asex$rep<-as.factor(asex$rep)

#sort by mpg (ascending) and cyl (descending)
# DATASET
asex <- asex[order(asex$treatment,asex$year),] 
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Model selection. Table 2

```{r}
# MODEL SELECTION
attach(asex)

# model 1: No cost of sex
m1 = x

# model 2: 2-fold cost of sex
m2 = (x*2)/(1+x)

# model 3: c-fold cost of sex
m3 = function(F0, c){ # function of F0 (x in prior models) and c, the cost of sex
  (F0*c)/(1+F0*(c-1))}

# model 4: c-fold cost of sex with treatment variation
m4 = function(F0,c0,c.exp){ # c0 is our base cost in control, modifies for exposed
  cdiff=c(0,c.exp) # this value is added to our cost - nothing added for control
  cost=c0+cdiff[asex$treatment] # the cost that we'll use, with the addition of cdiff indexed by treatment
  m4.tr=(F0*cost)/(1+F0*(cost-1)) # the same function as above
}

# negative log-likelihood functions
# model 1
NLL.m1<--sum(dbinom(y,size=z,prob=m1,log=TRUE)) 
# model 1.bb
NLL.m1.bb<- function (theta){
  p.trip=m1
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE)) 
}

# model 2
NLL.m2<--sum(dbinom(y,size=z,prob=m2,log=TRUE))
# model 2.bb
NLL.m2.bb<- function (theta){
  p.trip=m2
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE)) 
}

# model 3
NLL.m3 = function (c){
  p.trip = m3(x,c)
  -sum(dbinom(y,size=z,prob=p.trip,log=TRUE))
}
# model 3.bb
NLL.m3.bb = function (c,theta){
  p.trip = m3(x,c)
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE))
}

# model 4
NLL.m4 = function (c0,c.exp){
  p.trip = m4(x,c0,c.exp)
  -sum(dbinom(y,size=z,prob=p.trip,log=TRUE))
}
# model 4.bb
NLL.m4.bb = function (c0,c.exp,theta){
  p.trip = m4(x,c0,c.exp)
  -sum(dbetabinom(y,size=z,prob=p.trip,theta=theta,log=TRUE))
}

# optimization
# model 1.bb 
FSP.m1.bb = mle2(NLL.m1.bb,start=list(theta=10)) 

# model 2.bb 
FSP.m2.bb = mle2(NLL.m2.bb,start=list(theta=10)) 

# model 3 
FSP.m3 = mle2(NLL.m3,start=list(c=2))
# model 3.bb 
FSP.m3.bb = mle2(NLL.m3.bb,start=list(c=2,theta=10))
Cm3<-coef(FSP.m3.bb)[1]

# model 4 
FSP.m4 = mle2(NLL.m4,start=list(c0=2,c.exp=0))
# model 4.bb 
FSP.m4.bb = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))

C0m4<-coef(FSP.m4.bb)[1]
Cpm4<-coef(FSP.m4.bb)[2]

logL = c(NLL.m1,-logLik(FSP.m1.bb),NLL.m2,-logLik(FSP.m2.bb),-logLik(FSP.m3),-logLik(FSP.m3.bb),
         -logLik(FSP.m4),-logLik(FSP.m4.bb))
k = c(0,1,0,1,1,2,2,3)

# AICc values
# model 1
AICc1 = -2*(-NLL.m1)+2*0 + (2*0*(0+1))/(48-0-1)
# model 1.bb
AICc1.bb = -2*(logLik(FSP.m1.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)

# model 2
AICc2 = -2*(-NLL.m2)+2*0 + (2*0*(0+1))/(48-0-1)
# model 2.bb
AICc2.bb = -2*(logLik(FSP.m2.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)

# model 3
AICc3 = -2*(logLik(FSP.m3)[1])+2*1 + (2*1*(1+1))/(48-1-1)
# model 3.bb
AICc3.bb = -2*(logLik(FSP.m3.bb)[1])+2*2 + (2*2*(2+1))/(48-2-1)

# model 4
AICc4 = -2*(logLik(FSP.m4)[1])+2*2 + (2*2*(2+1))/(48-2-1)
# model 4.bb
AICc4.bb = -2*(logLik(FSP.m4.bb)[1])+2*3 + (2*3*(3+1))/(48-3-1)

AICc = c(AICc1,AICc1.bb,AICc2,AICc2.bb,AICc3,AICc3.bb,AICc4,AICc4.bb)

# delta AICs
# calculate AIC statistics for beta-binomial set only
logL = c(logLik(FSP.m1.bb),logLik(FSP.m2.bb),logLik(FSP.m3.bb),logLik(FSP.m4.bb))
k = c(1,1,2,3)
AICc = c(AICc1.bb,AICc2.bb,AICc3.bb,AICc4.bb)
base = rep(AICc4.bb,4)
delta = AICc-base
weights = rep(0,4)
for (i in 1:4){
  weights[i]<-(exp(-0.5*delta[i])/(exp(-0.5*delta[1])+exp(-0.5*delta[2])+exp(-0.5*delta[3])+exp(-0.5*delta[4])))
}
summary = as.table(cbind(round(logL,2),k,round(AICc,2),round(delta,2),round(weights,2)))
colnames(summary) = c("logL", "K","AICc","delta AIC","Akaike weights")
rownames(summary)<-c("no cost","2-fold cost","optimized cost",
                     "cost by treatment")

# TABLE 2
summary

detach(asex)
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Model selection probabilities

```{r}
# MODEL SELECTION PROBABILITIES
attach(asex)

m = 10000 
delta4 = rep(0,m)

delta = matrix(nrow=m,ncol=4)

for (i in 1:m) { 
  dboot<-asex[sample(1:48,48, replace=TRUE), ]
  NLL.m1.bb = function (theta){
    x=dboot$x
    p.trip=m1
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE)) #1 parameter to estimate
  }
  NLL.m2.bb = function (theta){
    x=dboot$x
    p.trip=m2
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE)) #1 parameter to estimate
  }
  NLL.m3.bb = function (c,theta){
    p.trip = m3(x,c)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  NLL.m4.bb = function (c0,c.exp,theta){
    p.trip = m4(x,c0,c.exp)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  
  FSP.m1.bb = mle2(NLL.m1.bb,start=list(theta=10)) 
  FSP.m2.bb = mle2(NLL.m2.bb,start=list(theta=10)) 
  FSP.m3.bb = mle2(NLL.m3.bb,start=list(c=2,theta=10)) # this result is sensitive to the starting value of theta
  FSP.m4.bb = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))
  
  AICc1 = -2*(logLik(FSP.m1.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)
  AICc2 = -2*(logLik(FSP.m2.bb)[1])+2*1 + (2*1*(1+1))/(48-1-1)
  AICc3 = -2*(logLik(FSP.m3.bb)[1])+2*2 + (2*2*(2+1))/(48-2-1)
  AICc4 = -2*(logLik(FSP.m4.bb)[1])+2*3 + (2*3*(3+1))/(48-3-1)
  
  minimum = min(c(AICc1,AICc2,AICc3,AICc4))
  delta4[i] = AICc4 - minimum
  delta[i,] = c(AICc1-minimum,AICc2-minimum, AICc3-minimum,AICc4-minimum)
}

delta4 = sort(delta4,decreasing=FALSE)
print("upper limit of AIC for 95% confidence set of models")
delta4[m*0.95] 

detach(asex)
```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Parameter estimation.

```{r}
# PARAMETER ESTIMATION - MODEL 3

attach(asex)

# model3
m = 10000 
cboot=rep(0,m)

for (i in 1:m) { 
  dboot<-asex[sample(1:48,48, replace=TRUE), ]
  NLL.m3.bb = function (c,theta){
    p.trip = m3(x,c)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  FSP.m3.bboot = mle2(NLL.m3.bb,start=list(c=2,theta=10)) # this result is sensitive to the starting value of theta
  cboot[i]=coef(FSP.m3.bboot)[1]
}

cboot = sort(cboot,decreasing=FALSE) 
lowc<-cboot[m*0.025]
highc<-cboot[m*0.975] 

t12<-matrix(c(lowc,Cm3,highc),nrow=3)
colnames(t12)=c("Estimate of the cost of sex, Model 3")
rownames(t12)=c("lower bound of 95% CI","Parameter estimate","upper bound of 95% CI")
t12

detach(asex)

```
Paragraphs 12 and 13 of the Results section. Estimating the cost of sex in the presence and absence of parasite selection; 2012-2015. Parameter estimation.

```{r}
# PARAMETER ESTIMATION - MODEL 4

attach(asex)
# model 4
m = 10000
cboot = rep(0,m)
c.expboot = rep(0,m) 

for (i in 1:m) { 
  control<-asex[sample(1:24,24, replace=TRUE), ]
  exposed<-asex[sample(25:48,24, replace=TRUE), ]
  
  dboot<-rbind(control, exposed)
  NLL.m4.bb = function (c0,c.exp,theta){
    p.trip = m4(x,c0,c.exp)
    -sum(dbetabinom(dboot$y,size=dboot$z,prob=p.trip,theta=theta,log=TRUE))
  }
  FSP.m4.bboot = mle2(NLL.m4.bb,start=list(c0=2,c.exp=0,theta=10))
  cboot[i]=coef(FSP.m4.bboot)[1]
  c.expboot[i]=coef(FSP.m4.bboot)[2]
}

cboot = sort(cboot,decreasing=FALSE) 
c.conlow<-cboot[m*0.025]
c.conhigh<-cboot[m*0.975]  

c.expboot = sort(c.expboot,decreasing=FALSE)
c.explow<-c.expboot[m*0.025] 
c.exphigh<-c.expboot[m*0.975] 

t13<-matrix(c(c.conlow,C0m4,c.conhigh,c.explow,Cpm4,c.exphigh),nrow=3,ncol=2)
colnames(t13)=c("C0 - baseline cost of sex","Cp - increase in cost of sex due to parasites")
rownames(t13)=c("lower bound of 95% CI","Parameter estimate","upper bound of 95% CI")
t13

detach(asex)
```

Experimental Results in the Appendix. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. GEE - Microphallus infection by sex and treatment; Table B8

```{r}
# MANIPULATION AND CALCULATIONS

# subset by sex and treatment
fC=subset(bm2,bm2$treatment==0 & bm2$sex==0)
fE=subset(bm2,bm2$treatment==1 & bm2$sex==0)
mC=subset(bm2,bm2$treatment==0 & bm2$sex==1)
mE=subset(bm2,bm2$treatment==1 & bm2$sex==1)

# control females
fCT=tapply(fC$mic,list(fC$year,fC$replicate),length)
LfCT=melt(fCT)
names(LfCT)=c("year","replicate","total")

fCM=tapply(fC$mic,list(fC$year,fC$replicate),sum)
LfCM=melt(fCM)
names(LfCM)=c("year","replicate","mic")

Cf<-cbind(LfCT,LfCM$mic)
names(Cf)=c("year","replicate","total","mic")
healthy=Cf$total-Cf$mic
sex=rep(0,length(Cf$year))
treatment=rep("control",length(Cf$year))
tank=rep(1:24)
Cf=cbind(Cf,healthy,sex,treatment,tank)

# exposed females
fET=tapply(fE$mic,list(fE$year,fE$replicate),length)
LfET=melt(fET)
names(LfET)=c("year","replicate","total")

fEM=tapply(fE$mic,list(fE$year,fE$replicate),sum)
LfEM=melt(fEM)
names(LfEM)=c("year","replicate","mic")

Ef<-cbind(LfET,LfEM$mic)
names(Ef)=c("year","replicate","total","mic")
healthy=Ef$total-Ef$mic
sex=rep(0,length(Ef$year))
treatment=rep("exposed",length(Ef$year))
tank=rep(25:48)
Ef=cbind(Ef,healthy,sex,treatment,tank)

# control males
mCT=tapply(mC$mic,list(mC$year,mC$replicate),length)
LmCT=melt(mCT)
names(LmCT)=c("year","replicate","total")

mCM=tapply(mC$mic,list(mC$year,mC$replicate),sum)
LmCM=melt(mCM)
names(LmCM)=c("year","replicate","mic")

Cm<-cbind(LmCT,LmCM$mic)
names(Cm)=c("year","replicate","total","mic")
healthy=Cm$total-Cm$mic
sex=rep(1,length(Cm$year))
treatment=rep("control",length(Cm$year))
tank=rep(1:24)
Cm=cbind(Cm,healthy,sex,treatment,tank)

# exposed males
mET=tapply(mE$mic,list(mE$year,mE$replicate),length)
LmET=melt(mET)
names(LmET)=c("year","replicate","total")

mEM=tapply(mE$mic,list(mE$year,mE$replicate),sum)
LmEM=melt(mEM)
names(LmEM)=c("year","replicate","mic")

Em<-cbind(LmET,LmEM$mic)
names(Em)=c("year","replicate","total","mic")
healthy=Em$total-Em$mic
sex=rep(1,length(Em$year))
treatment=rep("exposed",length(Em$year))
tank=rep(25:48)
Em=cbind(Em,healthy,sex,treatment,tank)

inf<-rbind(Cf,Cm,Ef,Em)

# STATISTICAL MODEL
geefit1<-geeglm( cbind(mic,healthy) ~ treatment+factor(year)+factor(sex)+
                   treatment*factor(year)+treatment*factor(sex)+factor(year)*factor(sex)+
                   treatment*factor(year)*factor(sex), 
                 family = binomial,data=inf,
                 id=tank,corstr="exchangeable")

# TABLE B8
anova(geefit1,test="Wald")
```

Experimental Results in Appendix A. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. Calculations

```{r}
# INFECTION RATE WITH MICROPHALLUS IN CONTROL TANKS - MALES V. DIPLOID FEMALES

# MANIPULATION ADN CALCULATIONS
Cf<-subset(bm2,bm2$treatment==0 & bm2$sex==0)
tCf=tapply(Cf$mic,list(Cf$replicate,Cf$year),length)
mCf=tapply(Cf$mic,list(Cf$replicate,Cf$year),sum)
fCf=mCf/tCf

Cm<-subset(bm2,bm2$treatment==0 & bm2$sex==1)
tCm=tapply(Cm$mic,list(Cm$replicate,Cm$year),length)
mCm=tapply(Cm$mic,list(Cm$replicate,Cm$year),sum)
fCm=mCm/tCm

m=c(mean(fCf),mean(fCm))
se=c(sd(fCf)/sqrt(24),sd(fCm)/sqrt(24))

# SUMMARY OF MICROPHALLUS INFECTION RATE IN CONTROL TANKS - MALE V DIPLOID FEMALES
t14<-cbind(m,se)
rownames(t14)<-c("diploid females","males")
colnames(t14)<-c("mean","se of mean")
t14
```

Experimental Results in Appendix A. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. Calculations

```{r}
# INFECTION RATE WITH MICROPHALLUS IN EXPOSED TANKS - MALES V DIPLOID FEMALES

# MANIPULATION AND CALCULATIONS
Ef<-subset(bm2, bm2$treatment==1 &bm2$sex==0)
tEf=tapply(Ef$mic,list(Ef$replicate,Ef$year),length)
mEf=tapply(Ef$mic,list(Ef$replicate,Ef$year),sum)
fEf=mEf/tEf

Em<-subset(bm2,bm2$treatment==1 & bm2$sex==1)
tEm=tapply(Em$mic,list(Em$replicate,Em$year),length)
mEm=tapply(Em$mic,list(Em$replicate,Em$year),sum)
fEm=mEm/tEm

m=c(mean(fEf),mean(fEm))
se=c(sd(fEf)/sqrt(24),sd(fEm)/sqrt(24))

# SUMMARY OF MICROPHALLUS INFECTION RATE IN EXPOSED TANKS - MALE V DIPLOID FEMALES
t15<-cbind(m,se)
rownames(t15)<-c("diploid females","males")
colnames(t15)<-c("mean","se of mean")
t15

```

Experimental Results in Appendix B. Comparison of sexual male and female infection rates in experimental exposures, 2012-2015. Figure B6

```{r}
# FIGURE B6

# MANIPULATION AND CALCULATIONS
fC=subset(bm2,bm2$treatment==0 & bm2$sex==0)
fE=subset(bm2,bm2$treatment==1 & bm2$sex==0)
mC=subset(bm2,bm2$treatment==0 & bm2$sex==1)
mE=subset(bm2,bm2$treatment==1 & bm2$sex==1)

# now divide each subset by tank and year
# control females
fCT=tapply(fC$mic,list(fC$year,fC$replicate),length)
LfCT=melt(fCT)
names(LfCT)=c("year","replicate","total")

fCM=tapply(fC$mic,list(fC$year,fC$replicate),sum)
LfCM=melt(fCM)
names(LfCM)=c("year","replicate","mic")

Cf<-cbind(LfCT,LfCM$mic)
names(Cf)=c("year","replicate","total","mic")
healthy=Cf$total-Cf$mic
sex=rep(0,length(Cf$year))
treatment=rep("control",length(Cf$year))
Cf=cbind(Cf,healthy,sex,treatment)

# exposed females
fET=tapply(fE$mic,list(fE$year,fE$replicate),length)
LfET=melt(fET)
names(LfET)=c("year","replicate","total")

fEM=tapply(fE$mic,list(fE$year,fE$replicate),sum)
LfEM=melt(fEM)
names(LfEM)=c("year","replicate","mic")

Ef<-cbind(LfET,LfEM$mic)
names(Ef)=c("year","replicate","total","mic")
healthy=Ef$total-Ef$mic
sex=rep(0,length(Ef$year))
treatment=rep("exposed",length(Ef$year))
Ef=cbind(Ef,healthy,sex,treatment)

# control males
mCT=tapply(mC$mic,list(mC$year,mC$replicate),length)
LmCT=melt(mCT)
names(LmCT)=c("year","replicate","total")

mCM=tapply(mC$mic,list(mC$year,mC$replicate),sum)
LmCM=melt(mCM)
names(LmCM)=c("year","replicate","mic")

Cm<-cbind(LmCT,LmCM$mic)
names(Cm)=c("year","replicate","total","mic")
healthy=Cm$total-Cm$mic
sex=rep(1,length(Cm$year))
treatment=rep("control",length(Cm$year))
Cm=cbind(Cm,healthy,sex,treatment)

# exposed males
mET=tapply(mE$mic,list(mE$year,mE$replicate),length)
LmET=melt(mET)
names(LmET)=c("year","replicate","total")

mEM=tapply(mE$mic,list(mE$year,mE$replicate),sum)
LmEM=melt(mEM)
names(LmEM)=c("year","replicate","mic")

Em<-cbind(LmET,LmEM$mic)
names(Em)=c("year","replicate","total","mic")
healthy=Em$total-Em$mic
sex=rep(1,length(Em$year))
treatment=rep("exposed",length(Em$year))
Em=cbind(Em,healthy,sex,treatment)

# now bring them all together
inf<-rbind(Cf,Cm,Ef,Em)

freq=inf$mic/inf$total
inf=cbind(inf,freq)

# FIGURE B6
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(inf$freq~inf$sex*inf$treatment,
        ylim=c(0,1),ylab="", # ylab=proportion infected, with all females up in the corner
        lwd=2,cex.axis=1,names=c("diploid females","males","diploid females","males"),
        xlab="",outcex=1.5,
        col=c("#bdbdbd","white"))
abline(v=2.5,lty=3)
text(1.5,0.9,"Control",cex=1)
text(3.5,0.9,"Exposed",cex=1)

# SAMPLE SIZE
m<-subset(inf,inf$sex==1)
m1<-mean(m$total)
se1<-sd(m$total)/sqrt(48)

f<-subset(inf,inf$sex==0)
m2<-mean(f$total)
se2<-sd(f$total)/sqrt(48)

# SUMMARY OF SAMPLE SIZE, FIGURE S6
t16<-matrix(c(m1,se1,m2,se2),nrow=2)
rownames(t16)<-c("mean individuals sampled","se")
colnames(t16)<-c("males","diploid females")
t16
```
Experimental Results in Appendix A. Comparison of male frequency (sex ratio) in experimental mesocosms, 2012-2015.Paragraphs 8+9 of Appendix A

```{r}
# FREQUENCIES OF ADULT MALES IN CONTROL AND EXPOSED TANKS

# MANIPULATION AND CALCULATIONS
# subset by treatment
C=subset(bm2,bm2$treatment==0)
E=subset(bm2,bm2$treatment==1)

# control tanks
CT=tapply(C$sex,list(C$year,C$replicate),length)
LCT=melt(CT)
names(LCT)=c("year","replicate","total")

CM=tapply(C$sex,list(C$year,C$replicate),sum)
LCM=melt(CM)
names(LCM)=c("year","replicate","male")

control<-cbind(LCT,LCM$male)
names(control)=c("year","replicate","total","male")
female=control$total-control$male
treatment=rep("control",length(control$year))
control=cbind(control,female,treatment)

# exposed tanks
ET=tapply(E$sex,list(E$year,E$replicate),length)
LET=melt(ET)
names(LET)=c("year","replicate","total")

EM=tapply(E$sex,list(E$year,E$replicate),sum)
LEM=melt(EM)
names(LEM)=c("year","replicate","male")

exposed<-cbind(LET,LEM$male)
names(exposed)=c("year","replicate","total","male")
female=exposed$total-exposed$male
treatment=rep("exposed",length(exposed$year))
exposed=cbind(exposed,female,treatment)

# frequencies
cfreq=control$male/control$total
efreq=exposed$male/exposed$total

m1<-mean(cfreq)
se1<-sd(cfreq)/sqrt(24)

m2<-mean(efreq)
se2<-sd(efreq)/sqrt(24)

# SUMMARY OF ADULT MALE FREQUENCIES IN CONTROL AND EXPOSED TANKS
t17<-matrix(c(m1,se1,m2,se2),nrow=2)
rownames(t17)=c("mean proportion male","se of mean")
colnames(t17)=c("Control mesocosms","Exposed mesocosms")
t17

ad.test(cfreq) 
ad.test(efreq) 
# paired t-test
t.test(cfreq,efreq,paired=TRUE) 

# non-parametric
wilcox.test(cfreq,efreq,paired=TRUE)
```
Experimental Results in Appendix A. Comparison of triploid frequency in experimental mesocosms, 2012-2015.Paragraphs 8+9 of Appendix A

```{r}
# FREQUENCIES OF ADULT FEMALES THAT WERE TRIPLOID IN CONTROL AND EXPOSED TANKS

# MANIPULATION AND CALCULATIONS
# subset by ploidy and treatment
aC=subset(ba,ba$treatment==0 & ba$ploidy==3)
aE=subset(ba,ba$treatment==1 & ba$ploidy==3)
sC=subset(ba,ba$treatment==0 & ba$ploidy==2)
sE=subset(ba,ba$treatment==1 & ba$ploidy==2)

# control asexuals
aCT=tapply(aC$ploidy,list(aC$year,aC$replicate),length)
LaCT=melt(aCT)
names(LaCT)=c("year","replicate","triploid")

# exposed asexuals
aET=tapply(aE$ploidy,list(aE$year,aE$replicate),length)
LaET=melt(aET)
names(LaET)=c("year","replicate","triploid")

# control sexuals
sCT=tapply(sC$ploidy,list(sC$year,sC$replicate),length)
LsCT=melt(sCT)
names(LsCT)=c("year","replicate","diploid")

# exposed sexuals
sET=tapply(sE$ploidy,list(sE$year,sE$replicate),length)
LsET=melt(sET)
names(LsET)=c("year","replicate","diploid")

LCT=cbind(LaCT,LsCT$diploid)
treatment=rep("control",length(LCT$triploid))
LCT=cbind(LCT,treatment)
names(LCT)=c("year","replicate","triploid","diploid","treatment")

LET=cbind(LaET,LsET$diploid)
treatment=rep("exposed",length(LET$triploid))
LET=cbind(LET,treatment)
names(LET)=c("year","replicate","triploid","diploid","treatment")

cfreq3=LCT$triploid/(LCT$triploid+LCT$diploid)
efreq3=LET$triploid/(LET$triploid+LET$diploid)

mean(cfreq3)
mean(efreq3)

ad.test(cfreq3)
ad.test(efreq3)
t.test(cfreq3,efreq3,paired=TRUE) 
wilcox.test(cfreq3,efreq3,paired=TRUE) 
```

Experimental Results in the Appendix.Figures B3 and B4: see chunks for Figures 2A and 2B, respectively


