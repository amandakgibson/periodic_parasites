---
title: "Gibsonetal2018_analysis-codes_field-data""
author: "Amanda Gibson""
date: "June 18 2018""
output: pdf_document
---

For paper Periodic, parasite-mediated selection for and against sex; Gibson, Delph, Vergara, and Lively 2018

Packages used
```{r}
# PACKAGES
library(reshape)
library(matrixStats)
library(Hmisc)
library(aod)
library(geepack)
options(digits=4)
```

Data sets
```{r}
# IMPORTING DATA
# 2001-2005; females with ploidy
dp1<-read.csv("Field-2001-2005.csv")
dp1<-subset(dp1,dp1$sex==0 & dp1$ploidy>0)

# 2012-2016 females with ploidy
d<-read.csv("Field-2012-2016.csv")
dp2<-subset(d,d$sex==0 & d$ploidy>0)
# for ambiguous ploidy content
d0<-subset(d,d$sex==0)

# 2012-2016, females with ploidy, 4 overlapping sites only
dp2sub<-subset(dp2,dp2$site!="jms" & dp2$site!="swend")
dp2sub$site<-factor(dp2sub$site)

# 2012-2016, males and females
dm2<-read.csv("Field-2012-2016_withmales.csv")
dm2<-subset(dm2,dm2$ploidy>0)
dm2_dip<-subset(dm2,dm2$ploidy==2)

# both periods combined
dp<-rbind(dp1,dp2)
dp<-subset(dp,dp$sex==0 & ploidy>0)
dp_l<-subset(dp,dp$sex==0 & length>0 & ploidy>0) # exclude snails without length

# both periods combined; overlapping sites only
dpsub<-rbind(dp1,dp2sub)
dpsub$site<-factor(dpsub$site)
dpsub_l<-subset(dpsub,dpsub$sex==0 & dpsub$length>0 & dpsub$ploidy>0) # exclude snails without length
dpsub_l$site<-factor(dpsub_l$site)

# bot periods; diploid sexuals only
dpdip<-subset(dp,dp$sex==0 & dp$length>0 & dp$ploidy==2)
# both periods; triploid asexuals only
dptrip<-subset(dp,dp$sex==0 & dp$length>0 & dp$ploidy==3)

# both periods; males and females
dm1<-read.csv("Field-2001-2005.csv")
dm<-rbind(dm1,dm2)
dm<-subset(dm,length>0 & ploidy>0)

```

Paragraph 1 of the Results section. Comparison of infection rates in asexual and sexual snails from 2001-2005. Replication of Vergara et al. 2014 Am Nat. Calculations
```{r}
# MICROPHALLUS INFECTION RATES 2001-2005, BY REPRODUCTIVE MODE

# MANIPULATIONS+CALCUATIONS
# infected and uninfected by year+site
# asexual snails
asex<-subset(dp1,dp1$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year+site
# sexual snails
sex<-subset(dp1,dp1$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

# mean microphallus infection rates; 2001-2004
earlyA<-subset(longaF,longaF$X2<2005)
earlyS<-subset(longsF,longsF$X2<2005)
mean1 = c(mean(earlyS$value),mean(earlyA$value))
se1 = c((sd(earlyS$value)/sqrt(length(earlyS$value))),sd(earlyA$value)/sqrt(length(earlyA$value)))

# mean 2005
A05<-subset(longaF,longaF$X2==2005)
S05<-subset(longsF,longsF$X2==2005)
mean2 = c(mean(S05$value),mean(A05$value))
se2 = c((sd(S05$value)/sqrt(length(S05$value))),sd(A05$value)/sqrt(length(A05$value)))

# SUMMARY OF MEAN MICROPHALLUS RATES; 2001-2005 BY REPRODUCTIVE MODE
t1<-cbind(mean1,se1,mean2,se2)
colnames(t1)=c("mean 2001-2004","se 2001-2004","mean 2005","se 2005")
rownames(t1)=c("sexual","asexual")
t1
```

Paragraph 1 of the Results section. Comparison of infection rates in asexual and sexual snails from 2001-2005. Replication of Vergara et al. 2014 Am Nat. Figure 1A.
```{r}
# FIGURE 1A

# MANIPULATIONS+CALCUATIONS
# asexuals
asex<-subset(dp1,dp1$ploidy==3)
Amic<-tapply(asex$mic,list(asex$year,asex$site),sum)
Atot<-tapply(asex$mic,list(asex$year,asex$site),length)
Afreq<-Amic/Atot

#weighted means by each year
Ameans<-rep(0,5)
for (i in 1:5) {
  Ameans[i]<-weighted.mean(Afreq[i,],Atot[i,],na.rm=TRUE)
}

# standard errors
v<-rep(0,5)
Asd<-rep(0,5)
for (i in 1:5){
  v[i]<-wtd.var(Afreq[i,],Atot[i,],na.rm=TRUE,normwt=TRUE)
  Asd[i]<-sqrt(v[i])
}
l<-c(4,4,4,4,3) 
Ase<-Asd/sqrt(l)

# sexuals
sex<-subset(dp1,dp1$ploidy==2)
Smic<-tapply(sex$mic,list(sex$year,sex$site),sum)
Stot<-tapply(sex$mic,list(sex$year,sex$site),length)
Sfreq<-Smic/Stot

# weighted means by year
Smeans<-rep(0,5)
for (i in 1:5) {
  Smeans[i]<-weighted.mean(Sfreq[i,],Stot[i,],na.rm=TRUE)
}

# standard errors
v<-rep(0,5)
Ssd<-rep(0,5)
for (i in 1:5){
  v[i]<-wtd.var(Sfreq[i,],Stot[i,],na.rm=TRUE,normwt=TRUE)
  Ssd[i]<-sqrt(v[i])
}

l<-c(4,4,4,4,4) #no issue here with na
Sse<-Ssd/sqrt(l)

# FIGURE 1A MAIN
# done with weighted means
par(las=1)
par(lwd=2)
par(col="gray20")
plot(Smeans,
     ylim=c(0,1),
     xlab="",
     ylab="",
     type="b",
     lty=1,
     pch=21,
   col="gray10",
     bg="#bdbdbd",
     cex=2.5,
     cex.axis=1,
     lwd=2,
     xaxt="n")
axis(1,at=c(1,2,3,4,5),labels=c("2001","2002","2003","2004","2005"),cex.axis=1)

arrows(c(1,2,3,4,5),Smeans-Sse,c(1,2,3,4,5),Smeans+Sse,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2)
arrows(c(1,2,3,4,5),Ameans-Ase,c(1,2,3,4,5),Ameans+Ase,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2)
lines(Ameans,
      type="b",
      lty=5,pch=23,col="gray10",bg="#525252",cex=2.5,lwd=2)
lines(Smeans,
      type="b",
      lty=1,pch=21,col="gray10",bg="#bdbdbd",cex=2.5,lwd=2)

legend(1,1.05,legend=c("sexual females","asexual females"),pch=c(21,23),pt.bg=c("#bdbdbd","#525252"),lty=c(1,5),
       col="gray10",lwd=2,pt.cex=2,cex=1,bty="n")

# FIGURE 1A INSET

# MANIPULATIONS+CALCUATIONS
# infected and uninfected by year+site
# asexual snails
asex<-subset(dp1,dp1$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year+site
# sexual snails
sex<-subset(dp1,dp1$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

# FIGURE 1A INSET
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(longsF$value,longaF$value,
        ylim=c(0,1),
        ylab="",
        lwd=2,cex.axis=1,cex.names=1,outcex=1.5,
        col=c("#bdbdbd","#525252"),names=c("sexual","asexual") )

# SAMPLE SIZE ESTIMATES

# 4 sites sampled per year
# 5 years
# snails sampled per year
m1<-mean(Atot,na.rm=TRUE) # 19 points
l1<-sum(!is.na(Atot))
se1<-sd(Atot,na.rm=TRUE)/sqrt(19)

m2<-mean(Stot,na.rm=TRUE) # 20 points
l2<-sum(!is.na(Stot))
se2<-sd(Stot,na.rm=TRUE)/sqrt(20)

# SAMPLE SIZE FIGURE 1A
t2<-matrix(c(m2,se2,l2,m1,se1,l1),nrow=3,ncol=2)
colnames(t2)=c("sexual","asexual")
rownames(t2)=c("mean # females","se of mean","number of prevalence estimates")
t2
```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. GLM - variation in infection rate in the field. All sites, females - Table 1A

```{r}
# STATISTICAL MODELS

# year and site and ploidy as predictors of Microphallus infection
# covariate length
lrfit <- glm(mic~site*factor(ploidy) + factor(year)*factor(ploidy) + length, data=dp2, family=binomial)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/1702

# testing year*ploidy interaction
lrfit2 <- glm(mic~site*factor(ploidy) + factor(year)+factor(ploidy) + length, family=binomial,data=dp2)
anova(lrfit2,lrfit,test="LRT")

# testing site*ploidy interaction
lrfit3 <- glm(mic~site + factor(year)+factor(ploidy) + length, family=binomial,data=dp2)
anova(lrfit3,lrfit2,test="LRT")
# final model- lrfit2

# TABLE 1A
anova(lrfit2,test="Chisq")

# coefficients
summary(lrfit2)

# pseudo-R2
lr <- glm( mic ~ 
             +  1, family = binomial,data=dp2)
1-logLik(lrfit2)/logLik(lr)

# LINEAR CONTRASTS - comparing degree of asexual under-infection between sites 
# site*ploidy interaction

# the degree of under-infection of asexuals is greatest at halfway:
# for halfway-camp, see summary(lrfit2) output
# halfway - jms
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#half-swamp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#half-swend
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,-1,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#half-wp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,-1)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

# other sites do not differ in the degree of under-infection (p>0.2)
#jms-swamp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#jms-swend
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#jms-wp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,-1)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#swamp-swend
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#swamp-wp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-1)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#swend-wp
l <- cbind(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. GLM - variation in infection rate in the field. Four overlapping sites, females. Table B1A
```{r}
# STATISTICAL MODELS

lrfit <- glm(mic~site*factor(ploidy) + factor(year)*factor(ploidy) + length, family=binomial,data=dp2sub)

# overdispersion 
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/1119

# testing the interaction of year*ploidy
lrfit2 <- glm(mic~site*factor(ploidy) + factor(year)+factor(ploidy) + length, family=binomial,data=dp2sub)
anova(lrfit2,lrfit,test="LRT")

# testing interaction site*ploidy
lrfit3 <- glm(mic~site + factor(year)+factor(ploidy) + length, family=binomial,data=dp2sub)
anova(lrfit3,lrfit2,test="LRT") 
# final model lrfit2

# TABLE B1A
anova(lrfit2,test="Chisq")

# coefficients
summary(lrfit2)

# pseudo-R2
lr <- glm( mic ~ 
             +  1, family = binomial,data=dp2sub)
1-logLik(lrfit2)/logLik(lr)

```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. GLM - variation in infection rate in the field. All sites, MALES INCLUDED

```{r}
# STATISTICAL MODELS

lrfit <- glm(mic~site*factor(ploidy) + factor(year)*factor(ploidy) + length, family=binomial,data=dm2)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/2136

# testing year*ploidy interaction
lrfit2 <- glm(mic~site*factor(ploidy) + factor(year)+factor(ploidy) + length, family=binomial,data=dm2)
anova(lrfit2,lrfit,test="LRT")

# testing site*ploidy interaction
lrfit3 <- glm(mic~site + factor(year)+factor(ploidy) + length, family=binomial,data=dm2)
anova(lrfit3,lrfit2,test="LRT")
# final model lrfit2

# MODEL NOT SHOWN IN TEXT - RESULTS MENTIONED IN APPENDIX A
anova(lrfit2,test="Chisq")
summary(lrfit2)

# pseudo-R2
lr <- glm( mic ~ 
             +  1, family = binomial,data=dm2)
1-logLik(lrfit2)/logLik(lr)
```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. All sites, females. 
```{r}
# MICROPHALLUS INFECTION RATES, 2012-2016, BY REPRODUCTIVE MODE

# MANIPULATION AND CALCUATIONS
# infected and uninfected by year+site
# asexual
asex<-subset(dp2,dp2$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year/site
# sexual
sex<-subset(dp2,dp2$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#means
m1 = c(mean(longsF$value),mean(longaF$value))
se1 = c((sd(longsF$value)/sqrt(length(longsF$value))),
       sd(longaF$value)/sqrt(length(longaF$value)))

# SUMMARY OF MEAN MICROPHALLUS RATES; 2012-2016 BY REPRODUCTIVE MODE
t3<-cbind(m1,se1)
colnames(t3)=c("mean 2012-2016","se 2012-2016")
rownames(t3)=c("sexual","asexual")
t3
```
Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. All sites, females.
```{r}
# FOLD DIFFERENCE IN SEXUAL V. ASEXUAL INFECTION RATE, BY SITE

# MANIPULATION AND CALCULATIONS
names(longsF)=c("site","year","mic")
meanS_site<-tapply(longsF$mic,c(longsF$site),mean)

names(longaF)=c("site","year","mic")
meanA_site<-tapply(longaF$mic,c(longaF$site),mean)

fold=meanA_site/meanS_site
# se of fold change
se_fold=fold*sqrt(((se2/mean2)^2)+((se1/mean1)^2))

# SUMMARY ASEXUAL INFECTION RATE/SEXUAL INFECTION RATE; BY SITE
t4<-cbind(fold,se_fold)
rownames(t4)=c("camp","halfway","jms","swamp","swend","wpoint")
colnames(t4)=c("sexual/asexual inf rate","se of ratio")
t4
```
Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. All sites, females.
```{r}
# MICROPHALLUS INFECTION RATE - BY SITE

# MANIPULATION AND CALCULATIONS
#### site and year means
# infected and uninfected by year/site
T<-t(tapply(dp2$mic,list(dp2$year,dp2$site),length))
I<-t(tapply(dp2$mic,list(dp2$year,dp2$site),sum))
F<-I/T
longF<-melt(F,id=c("year","frequency"))
colnames(longF)=c("site","year","mic")

site_mean<-tapply(longF$mic,list(longF$site),mean)
site_sd<-tapply(longF$mic,list(longF$site),sd)
site_se<-site_sd/sqrt(5)

# SUMMARY MICROPHALLUS INFECTION RATE BY SITE, 2012-2016
t<-cbind(site_mean,site_se)
rownames(t)=c("camp","halfway","jms","swamp","swend","wpoint")
colnames(t)=c("mean microphallus prevalence 2012-2016","se of mean")
t
```
Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. All sites, females.
```{r}
# MICROPHALLUS INFECTION RATE - BY YEAR

# MANIPULATION AND CALCULATIONS
year_mean<-tapply(longF$mic,list(longF$year),mean)
year_sd<-tapply(longF$mic,list(longF$year),sd)
year_se<-year_sd/sqrt(6)

# SUMMARY MICROPHALLUS INFECTION RATE BY YEAR
t5<-cbind(year_mean,year_se)
rownames(t5)=c("2012","2013","2014","2015","2016")
colnames(t5)=c("mean microphallus prevalence","se of mean")
t5
```
Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. Four sites, females. Results given in Table B1A footnote
```{r}
# MICROPHALLUS INFECTION RATE; 2012-2016; FOUR SITES ONLY (TABLE B1A)

# MANIPULATION AND CALCULATIONS
# infected and uninfected by year+site
# asexual
asex<-subset(dp2sub,dp2sub$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# sexual
sex<-subset(dp2sub,dp2sub$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#means
m1 = c(mean(longsF$value),mean(longaF$value))
se1 = c((sd(longsF$value)/sqrt(length(longsF$value))),
       sd(longaF$value)/sqrt(length(longaF$value)))

# SUMMARY OF MEAN MICROPHALLUS RATES; 2012-2016 BY REPRODUCTIVE MODE - FOUR OVERLAPPING SITES
# TABLE S1A
t6<-cbind(m1,se1)
colnames(t6)=c("mean 2012-2016","se 2012-2016")
rownames(t6)=c("sexual","asexual")
t6
```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Calculations. Ambiguous ploidy content - end of Methods section "Field surveys for infection prevalence and reproductive mode"

```{r}
d<-subset(d0,d0$ploidy!="NA")
l<-tapply(d$ploidy,list(d$site,d$year),length)

d2<-subset(d0,d0$ploidy==0)
l2<-tapply(d2$ploidy,list(d2$site,d2$year),length)
l2[is.na(l2)] <- 0

print("mean proportion of analyzed females excluded due to ambiguous DNA content in flow cytometry")
mean(l2/l)
print("standard error of mean")
sd(l2/l)/sqrt(30) # standard error of mean 
```

Paragraphs 2-3 of the Results section. Comparison of infection rates in sexual and asexual snails from 2012-2016. Figure1B
```{r}
# FIGURE 1B

# MANIPULATION AND CALCULATIONS
# asexuals
asex<-subset(dp2,dp2$ploidy==3)
Amic<-tapply(asex$mic,list(asex$year,asex$site),sum)
Atot<-tapply(asex$mic,list(asex$year,asex$site),length)
Afreq<-Amic/Atot

#weighted means 
Ameans<-rep(0,5)
for (i in 1:5) {
  Ameans[i]<-weighted.mean(Afreq[i,],Atot[i,],na.rm=TRUE)
}

# standard errors
v<-rep(0,5)
Asd<-rep(0,5)
for (i in 1:5){
  v[i]<-wtd.var(Afreq[i,],Atot[i,],na.rm=TRUE,normwt=TRUE)
  Asd[i]<-sqrt(v[i])
}
l<-c(3,6,6,6,6) 
Ase<-Asd/sqrt(l)

# sexuals
sex<-subset(dp2,dp2$ploidy==2)

Smic<-tapply(sex$mic,list(sex$year,sex$site),sum)
Stot<-tapply(sex$mic,list(sex$year,sex$site),length)
Sfreq<-Smic/Stot

# weighted means 
Smeans<-rep(0,5)
for (i in 1:5) {
  Smeans[i]<-weighted.mean(Sfreq[i,],Stot[i,],na.rm=TRUE)
}

# standard errors
v<-rep(0,5)
Ssd<-rep(0,5)
for (i in 1:5){
  v[i]<-wtd.var(Sfreq[i,],Stot[i,],na.rm=TRUE,normwt=TRUE)
  Ssd[i]<-sqrt(v[i])
}

#FIGURE 1B MAIN
par(las=1)
par(lwd=2)
par(col="gray20")
plot(Smeans,
     ylim=c(0,1),
     xlab="",
     ylab="",
     type="b",
     lty=1,
     pch=21,
     col="gray10",
     bg="#bdbdbd",
     cex=2.5,
     cex.axis=1,
     lwd=2,
     xaxt="n")
axis(1,at=c(1,2,3,4,5),labels=c("2012","2013","2014","2015","2016"),cex.axis=1)

arrows(c(1,2,3,4,5),Smeans-Sse,c(1,2,3,4,5),Smeans+Sse,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2)
arrows(c(1,2,3,4,5),Ameans-Ase,c(1,2,3,4,5),Ameans+Ase,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2)
lines(Ameans,
      type="b",
      lty=5,pch=23,col="gray10",bg="#525252",cex=2.5,lwd=2)
lines(Smeans,
      type="b",
      lty=5,pch=21,col="gray10",bg="#bdbdbd",cex=2.5,lwd=2)

# FIGURE 1B INSET

# MANIPULATION AND CALCULATIONS
# infected and uninfected by year/site
# asexual
asex<-subset(dp2,dp2$ploidy==3)
Amic<-tapply(asex$mic,list(asex$year,asex$site),sum)
Atot<-tapply(asex$mic,list(asex$year,asex$site),length)
Afreq<-Amic/Atot
longaF<-melt(Afreq,id=c("year","frequency"))

# sexual
sex<-subset(dp2,dp2$ploidy==2)
Smic<-tapply(sex$mic,list(sex$year,sex$site),sum)
Stot<-tapply(sex$mic,list(sex$year,sex$site),length)
Sfreq<-Smic/Stot
longsF<-melt(Sfreq,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#FIGURE 1B INSET
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(longsF$value,longaF$value,
        ylim=c(0,1),
        ylab="",
        lwd=2,cex.axis=1,cex.names=1,names=c("sexual","asexual"),
        col=c("#bdbdbd","#525252"),outcex=1.5) 

# SAMPLE SIZE ESTIMATES
# 6 sites sampled per year
# 5 years
# snails sampled per year
m1<-mean(Atot,na.rm=TRUE) # 27 points
l1<-sum(!is.na(Atot))
se1<-sd(Atot,na.rm=TRUE)/sqrt(27)

m2<-mean(Stot,na.rm=TRUE) # 30 points
l2<-sum(!is.na(Stot))
se2<-sd(Stot,na.rm=TRUE)/sqrt(30)

# SUMMARY SAMPLE SIZE FIGURE 1B
t7<-matrix(c(m2,se2,l2,m1,se1,l1),nrow=3,ncol=2)
colnames(t7)=c("sexual","asexual")
rownames(t7)=c("mean # females","se of mean","number of prevalence estimates")
t7

```
Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. GEE - variation in infection rate in the field. All sites, females - Table 1B

```{r}
# STATISTICAL MODELS

geefit1<-geeglm(mic~site*factor(ploidy)+factor(period)*factor(ploidy) + length, data=dp_l, family=binomial,id=year,corstr="exchangeable")

# testing site*ploidy interaction
geefit2<-geeglm(mic~site+factor(period)*factor(ploidy) + length, data=dp_l, family=binomial,id=year,corstr="exchangeable")
anova(geefit1,geefit2)  

# testing period*ploidy interaction
geefit3<-geeglm(mic~site+factor(period)+factor(ploidy) + length, data=dp_l, family=binomial,id=year,corstr="exchangeable")
anova(geefit2,geefit3)
# final model geefit2

# TABLE 1B
anova(geefit2,test="LRT") 

# coefficients
summary(geefit2)

```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. GEE - variation in infection rate in the field. Four sites, females - Table B1B
```{r}
# STATISTICAL MODELS
geefit1<-geeglm(mic~site*factor(period) + site*factor(ploidy)+factor(period)*factor(ploidy) + length, data=dpsub_l, family=binomial,id=year,corstr="exchangeable")

# testing site*ploidy interaction
geefit2<-geeglm(mic~site*factor(period) + factor(period)*factor(ploidy)+ length, data=dpsub_l, family=binomial,id=year,corstr="exchangeable")
anova(geefit1,geefit2)

# testing site*period interaction
geefit3<-geeglm(mic~site +factor(period)*factor(ploidy) + length, data=dpsub_l, family=binomial,id=year,corstr="exchangeable")
anova(geefit2,geefit3) 

# testing period*ploidy interaction
geefit4<-geeglm(mic~site +factor(period)+factor(ploidy) + length, data=dpsub_l, family=binomial,id=year,corstr="exchangeable")
anova(geefit3,geefit4) 
# final model = geefit3

# TABLE B1B
anova(geefit3,test="LRT")

# coefficients
summary(geefit3)
```

Paragraphs 4-5 of the Results section. Comparison of infection rates in asexual snails across both time periods. GEE - variation in infection rate in the field. All sites, asexual females only - Table B2A
```{r}
# STATISTICAL MODEL
geefit1<-geeglm(mic~site+ factor(period) + length, data=dptrip, family=binomial,id=year,corstr="exchangeable")

# TABLE B2A
anova(geefit1,test="LRT")

# coefficients
summary(geefit1)

```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual snails across both time periods. GEE - variation in infection rate in the field. All sites, sexual females only - Table B2B

```{r}
# STATISTICAL MODEL

geefit1<-geeglm(mic~site+ factor(period) + length, data=dpdip, family=binomial,id=year,corstr="exchangeable")

# TABLE B2B
anova(geefit1,test="LRT")

# coefficients
summary(geefit1)

```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. GEE - variation in infection rate in the field. All sites, females + males - MALES INCLUDED

```{r}
# STATISTICAL MODELS
geefit1<-geeglm(mic~site*factor(ploidy)+factor(period)*factor(ploidy) + length, data=dm, family=binomial,id=year,corstr="exchangeable")

# testing site*ploidy interaction
geefit2<-geeglm(mic~site+factor(period) * factor(ploidy) + length, data=dm, family=binomial,id=year,corstr="exchangeable")
anova(geefit1,geefit2) 
# final model geefit2

# MODEL NOT SHOWN IN TEXT - RESULTS MENTIONED IN APPENDIX A
anova(geefit2,test="LRT")

```
Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Calculations
```{r}
# MICROPHALLUS INFECTION RATE, ALL 10 YEARS - SEXUAL V ASEXUALS

# MANIPULATION AND CALCULATIONS
# all sites
# infected and uninfected by year/site
# asexual
asex<-subset(dp,dp$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year/site
# sexual
sex<-subset(dp,dp$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#means
m1 = c(mean(longsF$value),mean(longaF$value))
se1 = c((sd(longsF$value)/sqrt(length(longsF$value))),sd(longaF$value)/sqrt(length(longaF$value)))

# SUMMARY MICROPHALLUS INFECTION RATE; ALL 10 YEARS BY REPRODUCTIVE MODE
t8<-cbind(m1,se1)
colnames(t8)=c("mean Microphallus prevalence over 10 years","se of mean")
rownames(t8)=c("sexual","asexual")
t8

```
Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Calculations - reported in Table B1B

```{r}
# MICROPHALLUS INFECTION RATE, ALL 10 YEARS - SEXUAL V ASEXUALS

# MANIPULATION AND CALCULATIONS
# four overlapping sites
# infected and uninfected by year/site
# asexual
asex<-subset(dpsub,dpsub$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year/site
# sexual
sex<-subset(dpsub,dpsub$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#means
m1 = c(mean(longsF$value),mean(longaF$value))
se1 = c((sd(longsF$value)/sqrt(length(longsF$value))),sd(longaF$value)/sqrt(length(longaF$value)))

# SUMMARY MICROPHALLUS INFECTION RATE; ALL 10 YEARS BY REPRODUCTIVE MODE - FOUR OVERLAPPING SITES
# TABLE B1B
t9<-cbind(m1,se1)
colnames(t9)=c("mean Microphallus prevalence over 10 years","se of mean")
rownames(t9)=c("sexual","asexual")
t9

```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Calculations. Variance in infection rate

```{r}
# COEFFICIENTS OF VARIATION OF MICROPHALLUS INFECTION PREVALENCE OVER ALL SAMPLING YEARS

# MANIPULATION AND CALCULATIONS
# asexual infection rates
asex<-subset(dp,dp$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# sexual
sex<-subset(dp,dp$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

# Coefficient of variation
cvS<-sd(longsF$value)/mean(longsF$value)
cvA<-sd(longaF$value)/mean(longaF$value)

# bootstrap
# sexual
m = 10000 
cvBootS=rep(0,m)

for (i in 1:m) { 
  dboot<-longsF[sample(1:50,50, replace=TRUE), ]
  cvBootS[i]<-sd(dboot$value)/mean(dboot$value)
}

cvBootS = sort(cvBootS,decreasing=FALSE) 
lowS<-cvBootS[m*0.025]
highS<-cvBootS[m*0.975] 

# asexual
cvBootA=rep(0,m)

for (i in 1:m) { 
  dboot<-longaF[sample(1:46,46, replace=TRUE), ]
  cvBootA[i]<-sd(dboot$value)/mean(dboot$value)
}

cvBootA = sort(cvBootA,decreasing=FALSE) 
lowA<-cvBootA[m*0.025]
highA<-cvBootA[m*0.975] 

# SUMMARY OF VARIANCE IN MICROPHALLUS INFECTION RATE BY REPRODUCTIVE MODE
t10<-matrix(c(lowS,cvS,highS,lowA,cvA,highA),nrow=3,ncol=2)
colnames(t10)=c("Sexual","Asexual")
rownames(t10)=c("lower bound 95% CI","Coefficient of variation of Microphallus infection prevalence","upper bound 95% CI")
t10
```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Calculations

```{r}
#OVERALL PREVALENCE OF MICROPHALLUS RATE BY TIME PERIOD

# MANIPULATION AND CALCULATIONS
T<-t(tapply(dp$mic,list(dp$year,dp$site),length))
I<-t(tapply(dp$mic,list(dp$year,dp$site),sum))
F<-I/T
longF<-melt(F,id=c("year","frequency"))
longF<-na.omit(longF)

p1<-subset(longF,longF$X2<2012)
p2<-subset(longF,longF$X2>2005)

m1= c(mean(p1$value),mean(p2$value))
se1 = c((sd(p1$value)/sqrt(length(p1$value))),sd(p2$value)/sqrt(length(p2$value)))

# SUMMARY MICROPHALLUS INFECTION RATE BY TIME PERIOD
t11<-cbind(m1,se1)
colnames(t11)=c("overall mean Microphallus prevalence","se of mean")
rownames(t11)=c("2001-2005","2012-2016")
t11
```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Calculations - presented in Table B1B

```{r}
#OVERALL PREVALENCE OF MICROPHALLUS RATE BY TIME PERIOD - FOUR OVERLAPPING SITES

# MANIPULATION AND CALCULATIONS
T<-t(tapply(dpsub$mic,list(dpsub$year,dpsub$site),length))
I<-t(tapply(dpsub$mic,list(dpsub$year,dpsub$site),sum))
F<-I/T
longF<-melt(F,id=c("year","frequency"))
longF<-na.omit(longF)

p1<-subset(longF,longF$X2<2012)
p2<-subset(longF,longF$X2>2005)

m1= c(mean(p1$value),mean(p2$value))
se1 = c((sd(p1$value)/sqrt(length(p1$value))),sd(p2$value)/sqrt(length(p2$value)))

# SUMMARY MICROPHALLUS INFECTION RATE BY TIME PERIOD; FOUR OVERLAPPING SITES
# TABLE B1B
t12<-cbind(m1,se1)
colnames(t12)=c("overall mean Microphallus prevalence","se of mean")
rownames(t12)=c("2001-2005","2012-2016")
t12
```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Figure 1C
```{r}
# FIGURE 1C

# MANIPULATION AND CALCULATIONS
# infected and uninfected by year/site
# asexual
asex<-subset(dp,dp$ploidy==3)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))

# infected and uninfected by year/site
# sexual
sex<-subset(dp,dp$ploidy==2)
sT<-t(tapply(sex$mic,list(sex$year,sex$site),length))
sI<-t(tapply(sex$mic,list(sex$year,sex$site),sum))
sF<-sI/sT
longsF<-melt(sF,id=c("year","frequency"))

longsF<-na.omit(longsF)
longaF<-na.omit(longaF)

#FIGURE 1C
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(longsF$value,longaF$value,
        ylim=c(0,1),
        ylab="",
        lwd=2,cex.axis=1,cex.names=1,names=c("sexual","asexual"),
        col=c("#bdbdbd","#525252"))

# SAMPLE SIZE ESTIMATES
# per replicate 
# sexual
longsT<-melt(sT)
longsT<-na.omit(longsT)

s<-mean(longsT$value)
s_se<-sd(longsT$value)/sqrt(length(longsT$value))
s_l<-length(longsT$value)

#asexual
longaT<-melt(aT)
longaT<-na.omit(longaT)

a<-mean(longaT$value)
a_se<-sd(longaT$value)/sqrt(length(longaT$value))
a_l<-length(longaT$value)

# SAMPLE SIZE FIGURE 1C
t13<-matrix(c(s,s_se,s_l,a,a_se,a_l),nrow=3,ncol=2)
colnames(t13)=c("sexual","asexual")
rownames(t13)=c("mean # females","se of mean","number of prevalence estimates")
t13
```

Paragraphs 4-5 of the Results section. Comparison of infection rates in sexual and asexual snails across both time periods. Figure 1D

```{r}
# FIGURE 1D

# MANIPULATION AND CALCULATIONS
#  infected and uninfected by year
total<-t(tapply(dp$mic,list(dp$year,dp$site),length))
infections<-t(tapply(dp$mic,list(dp$year,dp$site),sum))

frequency = infections/total

freq<-melt(frequency)
freq<-na.omit(freq)

# FIGURE 1D
par(las=1)
par(lwd=2)
par(col="gray30")
boxplot(freq$value[1:20],freq$value[21:50],
        ylim=c(0,1),
        ylab="",names=c("2001-2005","2012-2016"),
        lwd=2,cex.axis=1,cex.names=1,outcex=1.5,
        col="gray90")

# SAMPLE SIZE ESTIMATES
# per replicate - 5 years in each box, per year
# sexual
t<-melt(total)
t<-na.omit(t)

p1<-mean(t$value[1:20])
p1_se<-sd(t$value[1:20]/sqrt(length(t$value[1:20])))
p1_l<-length(t$value[1:20])

#asexual
p2<-mean(t$value[21:50])
p2_se<-sd(t$value[21:50]/sqrt(length(t$value[21:50])))
p2_l<-length(t$value[21:50])

# SAMPLE SIZE FIGURE 1C
t14<-matrix(c(p1,p1_se,p1_l,p2,p2_se,p2_l),nrow=3,ncol=2)
colnames(t14)=c("2001-2005","2012-2016")
rownames(t14)=c("mean # females","se of mean","number of estimates of asexual frequency")
t14
```

Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. quasi-GLM - variation in asexual frequency in the field across periods. All sites, females - Table B3A

```{r}
# MANIPULATION AND CALCULATIONS
# triploids
dpA<-subset(dp,dp$ploidy==3)
matrixA<-tapply(dpA$ploidy,list(dpA$year,dpA$site),length)
longA<-melt(matrixA,id=c("year","site"))
colnames(longA)=c("year","site","triploid")

# diploids
dpS<-subset(dp,dp$ploidy==2)
matrixS<-tapply(dpS$ploidy,list(dpS$year,dpS$site),length)
longS<-melt(matrixS,id=c("year","site"))
colnames(longS)=c("year","site","diploid")

long<-cbind(longA,longS$diploid)
colnames(long)=c("year","site","triploid","diploid")

period<-rep(c(0,0,0,0,0,1,1,1,1,1),6)

long<-cbind(period,long)

#delete non-existent rows where we don't have data
long_final<-long[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]

long_final[is.na(long_final)] <- 0
df.manip<-data.frame(long_final)

# STATISTICAL MODELS

lrfit <- glm(cbind(triploid,diploid)~ site+factor(period), family=binomial,data=df.manip)

# overdispersion 
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/43 

# TABLE B3A
#quasi 

anova(lrfitq1, test="F")
```

Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. quasi-GLM - variation in asexual frequency in the field across periods. Four overlapping sites, females - Table B3B

```{r}
# MANIPULATION AND CALCULATIONS

# triploids
dpsubA<-subset(dpsub,dpsub$ploidy==3)
matrixA<-tapply(dpsubA$ploidy,list(dpsubA$year,dpsubA$site),length)
longA<-melt(matrixA,id=c("year","site"))
colnames(longA)=c("year","site","triploid")

# diploids
dpsubS<-subset(dpsub,dpsub$ploidy==2)
matrixS<-tapply(dpsubS$ploidy,list(dpsubS$year,dpsubS$site),length)
longS<-melt(matrixS,id=c("year","site"))
colnames(longS)=c("year","site","diploid")

long<-cbind(longA,longS$diploid)
colnames(long)=c("year","site","triploid","diploid")

period<-rep(c(0,0,0,0,0,1,1,1,1,1),4)

long<-cbind(period,long)

long[is.na(long)] <- 0
df.manip<-data.frame(long)

# STATISTICAL MODELS
lrfit <- glm(cbind(triploid,diploid)~ site*factor(period), family=binomial,data=df.manip)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/32 

# quasi
# TABLE B3B
lrfitq1<-glm(cbind(triploid,diploid)~ site*factor(period), family=quasibinomial,data=df.manip)

anova(lrfitq1, test="F")
```

Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. quasi-GLM - variation in asexual frequency in the field across periods. All sites, males + females - MALES INCLUDED

```{r}
# MANIPULATION AND CALCULATIONS

# triploids
dmA<-subset(dm,dm$ploidy==3)
matrixA<-tapply(dmA$ploidy,list(dmA$year,dmA$site),length)
longA<-melt(matrixA,id=c("year","site"))
colnames(longA)=c("year","site","triploid")

# diploids
dmS<-subset(dm,dm$ploidy==2)
matrixS<-tapply(dmS$ploidy,list(dmS$year,dmS$site),length)
longS<-melt(matrixS,id=c("year","site"))
colnames(longS)=c("year","site","diploid")

long<-cbind(longA,longS$diploid)
colnames(long)=c("year","site","triploid","diploid")
period<-rep(c(0,0,0,0,0,1,1,1,1,1),6)
long<-cbind(period,long)

#delete non-existent rows where we don't have data
long_final<-long[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-41,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]
long_final<-long_final[-46,]

long_final[is.na(long_final)] <- 0
df.manip<-data.frame(long_final)

# STATISTICAL MODEL
lrfit <- glm(cbind(triploid,diploid)~ site+factor(period), family=binomial,data=df.manip)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/43 

# quasi
lrfitq1<-glm(cbind(triploid,diploid)~ site+factor(period), family=quasibinomial,data=df.manip)

# MODEL NOT SHOWN IN TEXT - RESULTS MENTIONED IN APPENDIX A
anova(lrfitq1,test="F")
```
Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. Calculations

```{r}
# ASEXUAL FREQUENCY ACROSS TIME PERIODS

# MANIPULATION AND CALCULATIONS
# females, asexual vs. sexual
# mean prevalence of asexuals
# mean over each site*year 
dp$ploidy[dp$ploidy==2]<-0
dp$ploidy[dp$ploidy==3]<-1

# sexuals and asexuals by site and year
T<-t(tapply(dp$ploidy,list(dp$year,dp$site),length))
A<-t(tapply(dp$ploidy,list(dp$year,dp$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
m1 = c(mean(longF$value[1:30],na.rm=T),mean(longF$value[31:60]))
se1 = c((sd(longF$value[1:30],na.rm=T)/sqrt(20)),
       sd(longF$value[31:60])/sqrt(length(longF$value[31:60])))

# SUMMARY OF ASEXUAL FREQUENCY IN TWO TIME PERIODS
t15<-cbind(m1,se1)
rownames(t15)=c("2001-2005","2012-2016")
colnames(t15)=c("mean proportion asexual females","se of mean")
t15
```
Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. Calculations - presented in Table B3B

```{r}
# ASEXUAL FREQUENCY ACROSS TIME PERIODS

# MANIPULATION AND CALCULATIONS
#4 overlapping sites
dpsub$ploidy[dpsub$ploidy==2]<-0
dpsub$ploidy[dpsub$ploidy==3]<-1

# sexuals and asexuals by site and year
T<-t(tapply(dpsub$ploidy,list(dpsub$year,dpsub$site),length))
A<-t(tapply(dpsub$ploidy,list(dpsub$year,dpsub$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
m1 = c(mean(longF$value[1:20]),mean(longF$value[21:40]))
se1 = c((sd(longF$value[1:20])/sqrt(length(longF$value[1:20]))),
       sd(longF$value[21:40])/sqrt(length(longF$value[21:40])))

# SUMMARY OF ASEXUAL FREQUENCY IN TWO TIME PERIODS, FOUR OVERLAPPING SITES
# TABLE B3B
t16<-cbind(m1,se1)
rownames(t16)=c("2001-2005","2012-2016")
colnames(t16)=c("mean proportion asexual females","se of mean")
t16
```


Paragraphs 6 of the Results section. Comparison of asexual frequency in 2001-2005 v. 2012-2016. Figure 1E

```{r}
# FIGURE 1E

# MANIPULATION AND CALCULATIONS
#  sex, asex by year
total<-t(tapply(dp$ploidy,list(dp$year,dp$site),length))
asex<-t(tapply(dp$ploidy,list(dp$year,dp$site),sum))

frequency = asex/total

freq<-melt(frequency)
freq<-na.omit(freq)

# FIGURE 1E
par(las=1)
par(lwd=2)
par(col="gray30")
boxplot(freq$value[1:20],freq$value[21:50],
        ylim=c(0,1),
        ylab="",names=c("2001-2005","2012-2016"),
        lwd=2,cex.axis=1, cex.names=1,outcex=1.5,
        col="gray90")

# SAMPLE SIZE ESTIMATES
# per replicate - 5 years in each box, per year
# sexual
t<-melt(total)
t<-na.omit(t)

p1<-mean(t$value[1:20])
p1_se<-sd(t$value[1:20]/sqrt(length(t$value[1:20])))
p1_l<-length(t$value[1:20])

#asexual
p2<-mean(t$value[21:50])
p2_se<-sd(t$value[21:50]/sqrt(length(t$value[21:50])))
p2_l<-length(t$value[21:50])

# SAMPLE SIZE FIGURE 1E (SAME AS FIGURE 1D)
t17<-matrix(c(p1,p1_se,p1_l,p2,p2_se,p2_l),nrow=3,ncol=2)
colnames(t17)=c("2001-2005","2012-2016")
rownames(t17)=c("mean # females","se of mean","number of estimates of asexual frequency")
t17
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. GLM - variation in asexual frequency in the field from 2012-2016. All sites, females. Table 3

```{r}
# MANIPULATION AND CALCULATIONS
dp2$ploidy[dp2$ploidy==2]<-0
dp2$ploidy[dp2$ploidy==3]<-1

# STATISTICAL MODELS

lrfit <- glm(ploidy~site*factor(year), data=dp2, family=binomial)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/1693

# testing site*year interaction
lrfit2 <- glm(ploidy~site+factor(year), data=dp2,family=binomial)
anova(lrfit2,lrfit,test="LRT")
# final model lrfit

# TABLE 3
anova(lrfit,test="Chisq")

# pseudo-R2
lr <- glm( ploidy~ 
             +  1,  family = binomial,data=dp2)
1-logLik(lrfit)/logLik(lr)

# odds ratios using reduced model,lrfit2
exp(coef(lrfit2))
exp(cbind(OR = coef(lrfit2), confint(lrfit2)))

# linear contrasts to measure yearly changes
# 2016 against 
# 2015
l <- cbind(0,0,0,0,0,0,0,0,1,-1)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

# 2015 against 
# 2014
l <- cbind(0,0,0,0,0,0,0,1,-1,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

# 2014 against 
# 2013
l <- cbind(0,0,0,0,0,0,1,-1,0,0)
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), L = l) 

#2013 against
# 2012
wald.test(b = coef(lrfit2), Sigma = vcov(lrfit2), Terms = 7)
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. GLM - variation in asexual frequency in the field from 2012-2016. Four overlapping sites, females. Table B6

```{r}
# MANIPULATION AND CALCULATIONS
dp2sub$ploidy[dp2sub$ploidy==2]<-0
dp2sub$ploidy[dp2sub$ploidy==3]<-1

# STATISTICAL MODELS
lrfit <- glm(ploidy~site*factor(year), data=dp2sub, family=binomial)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/1693

# testing site*year interaction
lrfit2 <- glm(ploidy~site+factor(year), data=dp2sub,family=binomial)
anova(lrfit2,lrfit,test="LRT")
# final model lrfit

#TABLE B6
anova(lrfit,test="Chisq")

# pseudo-R2
lr <- glm( ploidy~ 
             +  1, family = binomial,data=dp2sub)
1-logLik(lrfit)/logLik(lr)

# odds ratios, reduced model lrfit2
exp(coef(lrfit2))
exp(cbind(OR = coef(lrfit2), confint(lrfit2)))
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. GLM - variation in asexual frequency in the field from 2012-2016. All sites, females+males - MALES INCLUDED

```{r}
# MANIPULATION AND CALCULATION
dm2$ploidy[dm2$ploidy==2]<-0
dm2$ploidy[dm2$ploidy==3]<-1

# STATISTICAL MODELS
lrfit <- glm(ploidy~site*factor(year), data=dm2, family=binomial)

# overdispersion
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/2127

# testing site*year interaction
lrfit2 <- glm(ploidy~site+factor(year), data=dm2,family=binomial)
anova(lrfit2,lrfit,test="LRT")
# final mode, lrfit

# pseudo-R2
lr <- glm( ploidy~ 
             +  1,family = binomial,data=dm2)
1-logLik(lrfit)/logLik(lr)

# MODEL NOT PRESENTED IN RESULTS - MENTIONED IN APPENDIX A
anova(lrfit,test="Chisq")

# odds ratios
exp(coef(lrfit2))
exp(cbind(OR = coef(lrfit2), confint(lrfit2)))
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Calculations

```{r}
# FREQUENCIES OF ASEXUALS BY YEAR, 2012-2016

# MANIPULATION AND CALCULATIONS
# sexuals and asexuals by site and year
T<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),length))
A<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
m = c(mean(longF$value[1:6]),mean(longF$value[7:12]),mean(longF$value[13:18]),
         mean(longF$value[19:24]),mean(longF$value[25:30]))
se = c(sd(longF$value[1:6])/sqrt(6),sd(longF$value[7:12])/sqrt(6),sd(longF$value[13:18])/sqrt(6),
       sd(longF$value[19:24])/sqrt(6),sd(longF$value[25:30])/sqrt(6))

# SUMMARY OF ASEXUAL FREQUENCY FROM 2012-2016
t18<-cbind(m,se)
rownames(t18)=c("2012","2013","2014","2015","2016")
colnames(t18)=c("mean proportion asexual females","se of mean")
t18
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Calculations

```{r}
#cOST OF SEX BY YEAR - all sites

# MANIPULATION AND CALCULATIONS
# sexuals and asexuals by site and year
T<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),length))
A<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
m = c(mean(longF$value[1:6]),mean(longF$value[7:12]),mean(longF$value[13:18]),
         mean(longF$value[19:24]),mean(longF$value[25:30]))
se = c(sd(longF$value[1:6])/sqrt(6),sd(longF$value[7:12])/sqrt(6),sd(longF$value[13:18])/sqrt(6),
       sd(longF$value[19:24])/sqrt(6),sd(longF$value[25:30])/sqrt(6))

# use mean to calculate cost of sex for each year
qt = m[1:4]
qt1 = m[2:5]

c = (qt1*(1-qt))/(qt*(1-qt1))

# SUMMARY OF COST OF SEX BY YEAR
t19<-cbind(c)
rownames(t19)=c("2012","2013","2014","2015")
colnames(t19)=c("cost of sex")
t19
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016; four overlapping sites. Calculations - results presented in Table B6

```{r}
# FREQUENCIES OF ASEXUALS BY YEAR, 2012-2016 - overlapping sites only 

# MANIPULATION AND CALCULATIONS
###restrict to overlapping sites
# sexuals and asexuals by site and year
T<-t(tapply(dp2sub$ploidy,list(dp2sub$year,dp2sub$site),length))
A<-t(tapply(dp2sub$ploidy,list(dp2sub$year,dp2sub$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
m = c(mean(longF$value[1:4]),mean(longF$value[5:8]),mean(longF$value[9:12]),
         mean(longF$value[13:16]),mean(longF$value[17:20]))
se = c(sd(longF$value[1:4])/sqrt(4),sd(longF$value[5:8])/sqrt(4),sd(longF$value[9:12])/sqrt(4),
       sd(longF$value[13:16])/sqrt(4),sd(longF$value[17:20])/sqrt(4))

# SUMMARY OF ASEXUAL FREQUENCY FROM 2012-2016, FOUR SITES
# TABLE B6
t20<-cbind(m,se)
rownames(t20)=c("2012","2013","2014","2015","2016")
colnames(t20)=c("mean proportion asexual females","se of mean")
t20
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Calculations

```{r}
# VARIATION IN ASEXUAL FREQUENCY BY SITE

# MANIPULATION AND CALCULATIONS
# probability of sampling an asexual female, by site
# sexuals and asexuals by site and year
T<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),length))
A<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))
names(longF)=c("site","year","frequency")

# INDIVIDUAL SITES; ASEXUAL FREQUENCY
F
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Calculations

```{r}
# VARIATION IN MICROPHALLUS PREVALENCE BETWEEN SITES

# MANIPULATION AND CALCULATIONS
 # probability of mic infection by site
# for asexuals only

# summarize by site
# infected and uninfected by year/site
# asexual
asex<-subset(dp2,dp2$ploidy==1)
aT<-t(tapply(asex$mic,list(asex$year,asex$site),length))
aI<-t(tapply(asex$mic,list(asex$year,asex$site),sum))
aF<-aI/aT
longaF<-melt(aF,id=c("year","frequency"))
longaF<-na.omit(longaF)
colnames(longaF)=c("site","year","prevalence")
longaT<-melt(aT,id=c("year","frequency"))
colnames(longaT)=c("site","year","number of asexuals sampled")

# RESULTS FOR:
# JMS
jms<-subset(longaF,longaF$site=="jms")
jms
jms_counts<-subset(longaT,longaT$site=="jms")
jms_counts

# SWAMP
swamp<-subset(longaF,longaF$site=="swamp")
swamp
swamp_counts<-subset(longaT,longaT$site=="swamp")
swamp_counts

# OTHER FOUR SITES
#means
subaF<-subset(longaF,longaF$site!="swamp" & longaF$site!="jms")
print("mean prevalence of Microphallus in asexuals at Camp, Halfway, SWEnd, and WPoint")
mean(subaF$prevalence)
print("se of mean prevalence of Microphallus in asexuals at Camp, Halfway, SWEnd, and WPoint")
sd(subaF$prevalence)/sqrt(length(subaF$prevalence))
print("max prevalence of microphallus in asexuals across these sites")
max(subaF$prevalence)
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Figure 3A

```{r}
# FIGURE 3A

# MANIPULATION AND CALCULATIONS
# sexuals and asexuals by site and year
T<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),length))
A<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),sum))
F<-A/T
longF<-melt(F,id=c("site","year","frequency"))

# means
mean = c(mean(longF$value[1:6]),mean(longF$value[7:12]),mean(longF$value[13:18]),
         mean(longF$value[19:24]),mean(longF$value[25:30]))
se = c(sd(longF$value[1:6])/sqrt(6),sd(longF$value[7:12])/sqrt(6),sd(longF$value[13:18])/sqrt(6),
       sd(longF$value[19:24])/sqrt(6),sd(longF$value[25:30])/sqrt(6))

# FIGURE 3A
par(las=1)
par(lwd=2)
par(col="gray30")
plot(mean,
     ylim=c(0,0.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=2.5, bg="gray50",
     xaxt="n",type="b",lty=2)
axis(1, at=c(1,2,3,4,5),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
arrows(c(1,2,3,4,5),mean-se,c(1,2,3,4,5),mean+se,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(mean,pch=21, cex=2.5, bg="gray50")

# SAMPLE SIZE FIGURE 3
m<-mean(T)
se<-sd(T)/sqrt(30)

t21<-rbind(m,se)
rownames(t21)=c("mean number of females sampled", "se of mean")
colnames(t21)=c("for Figure 3")
t21
```

Paragraphs 14-17 of the Results section. Change in asexual frequency from 2012 to 2016. Figure 3B

```{r}
# FIGURE 3B

# MANIPULATION AND CALCULATIONS
# sexuals and asexuals by site and year
T<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),length))
A<-t(tapply(dp2$ploidy,list(dp2$year,dp2$site),sum))
F<-A/T

longF<-melt(F,id=c("site","year","frequency"))
names(longF)=c("site","year","frequency")

longT<-melt(T,id=c("site","year","frequency"))
names(longT)=c("site","year","total")

# site by site
# SWEND
swe<-subset(longF,longF$site=="swend")
tswe<-subset(longT,longT$site=="swend")
mswe=mean(swe$frequency)

#standard error of the proportion
se_swe=sqrt((swe$frequency*(1-swe$frequency))/tswe$total)

# FIGURE 3B UPPER LEFT
par(las=1)
par(lwd=2)
par(col="gray30")
plot(swe$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=2.5, bg="gray50",
     xaxt="n",type="b",lty=3)
axis(1, at=c(1,2,3,4,5),labels=c("","","","",""),
     cex.axis=1)
arrows(c(1,2,3,4,5),swe$frequency-se_swe,c(1,2,3,4,5),swe$frequency+se_swe,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(swe$frequency,pch=21, cex=3, bg="gray50") #bg="#0571b0")
text(2,0.92,"Southwest End",cex=2.2,col="black")

# CAMP
camp<-subset(longF,longF$site=="camp")
tcamp<-subset(longT,longT$site=="camp")
mcamp=mean(camp$frequency)

#standard error of the proportion
se_camp=sqrt((camp$frequency*(1-camp$frequency))/tcamp$total)

# FIGURE 3B UPPER RIGHT
# plot camp
par(las=1)
par(lwd=2)
par(col="gray30")
plot(camp$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg="gray50",
     xaxt="n",type="b",lty=3,
     yaxt="n")
axis(1, at=c(1,2,3,4,5),labels=c("","","","",""),
     cex.axis=1)
arrows(c(1,2,3,4,5),camp$frequency-se_camp,c(1,2,3,4,5),camp$frequency+se_camp,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(camp$frequency,pch=21, cex=3, bg="gray50")
text(1.4,0.92,"Camp",cex=2.2,col="black")

#WPOINT
wp<-subset(longF,longF$site=="wpoint")
twp<-subset(longT,longT$site=="wpoint")
mwp=mean(wp$frequency)

#standard error of the proportion
se_wp=sqrt((wp$frequency*(1-wp$frequency))/twp$total)

# FIGURE 3B CENTER LEFT
par(las=1)
par(lwd=2)
par(col="gray30")
par(mar=c(2,5,1,1))
plot(wp$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg="gray50",
     xaxt="n",type="b",lty=3)
axis(1, at=c(1,2,3,4,5),labels=c("","","","",""),
     cex.axis=1)
arrows(c(1,2,3,4,5),wp$frequency-se_wp,c(1,2,3,4,5),wp$frequency+se_wp,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(wp$frequency,pch=21, cex=3,bg="gray50") #bg="gray40")
text(1.7,0.92,"West Point",cex=2.2,col="black")


# HALFWAY
hw<-subset(longF,longF$site=="halfway")
thw<-subset(longT,longT$site=="halfway")
mhw=mean(hw$frequency)

#standard error of the proportion
se_hw=sqrt((hw$frequency*(1-hw$frequency))/thw$total)

# FIGURE 3B CENTER RIGHT
par(las=1)
par(lwd=2)
par(col="gray30")
plot(hw$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=2.5, bg="gray50",
     xaxt="n",type="b",lty=3,
     yaxt="n")
axis(1, at=c(1,2,3,4,5),labels=c("","","","",""),
     cex.axis=1)
arrows(c(1,2,3,4,5),hw$frequency-se_hw,c(1,2,3,4,5),hw$frequency+se_hw,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(hw$frequency,pch=21, cex=3,bg="gray50") #bg="gray40")
text(1.5,0.92,"Halfway",cex=2.2,col="black")

#JMS
jms<-subset(longF,longF$site=="jms")
tjms<-subset(longT,longT$site=="jms")
mjms=mean(jms$frequency)

#standard error of the proportion
se_jms=sqrt((jms$frequency*(1-jms$frequency))/tjms$total)

# FIGURE 3B BOTTOM LEFT
par(las=1)
par(lwd=2)
par(col="gray30")
plot(jms$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=2.5, bg="gray50",
     xaxt="n",type="b",lty=3)
axis(1, at=c(1,2,3,4,5),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
arrows(c(1,2,3,4,5),jms$frequency-se_jms,c(1,2,3,4,5),jms$frequency+se_jms,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(jms$frequency,pch=21, cex=3,bg="gray50") #bg="#ca0020")
text(1.3,0.92,"JMS",cex=2.2,col="black")

#SWAMP
swa<-subset(longF,longF$site=="swamp")
tswa<-subset(longT,longT$site=="swamp")
mswa=mean(swa$frequency)

#standard error of the proportion
se_swa=sqrt((swa$frequency*(1-swa$frequency))/tswa$total)

# FIGURE 3B BOTTOM RIGHT
par(las=1)
par(lwd=2)
par(col="gray30")
plot(swa$frequency,
     ylim=c(0,1),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=2.5, bg="gray50",
     xaxt="n",type="b",lty=3,
     yaxt="n")
axis(1, at=c(1,2,3,4,5),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
arrows(c(1,2,3,4,5),swa$frequency-se_swa,c(1,2,3,4,5),swa$frequency+se_swa,
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=2,
       col="gray30")
points(swa$frequency,pch=21, cex=3, bg="gray50")#bg="#ca0020")
text(1.5,0.92,"Swamp",cex=2.2,col="black")
```

Field Results in the Appendix. Comparison of sexual male and female infection rates in the field, 2012-2016. GLM - variation in infection rate in sexual individuals in the field from 2012-2016. All sites. Table B7

```{r}
# STATISTICAL MODELS

lrfit <- glm(mic~site*factor(year)*factor(sex) + length, family=binomial,data=dm2_dip)

# overdispersion 
sumsquare = sum(residuals(lrfit, type = "pearson")^2)
sumsquare/1712

# testing three-way interaction
lrfit2 <- glm(mic~site*factor(year)+site*factor(sex)+factor(year)*factor(sex) + length, family=binomial,data=dm2_dip)
anova(lrfit2,lrfit,test="LRT")

# testing site*sex interaction
lrfit3 <- glm(mic~site*factor(year)+factor(year)*factor(sex) + length, family=binomial,data=dm2_dip)
anova(lrfit3,lrfit2,test="LRT")
# final model lrfit3

# TABLE B7
anova(lrfit3,test="Chisq")

# pseudo-r2
lr <- glm( mic~ 
             +  1, family = binomial,data=dm2_dip)
1-logLik(lrfit3)/logLik(lr)

```

Field Results in APPENDIX A. Comparison of sexual male and female infection rates in the field, 2012-2016. Calculations

```{r}
#  PREVALENCE OF MICROPHALLUS INFECTION IN MALES V DIPLOID FEMALES

# MANIPULATION AND CALCULATIONS
# infected and uninfected by year/site
# female
Fem<-subset(dm2_dip,dm2_dip$sex==0)
FT<-t(tapply(Fem$mic,list(Fem$year,Fem$site),length))
FI<-t(tapply(Fem$mic,list(Fem$year,Fem$site),sum))
FF<-FI/FT
longFF<-melt(FF,id=c("year","frequency"))

# infected and uninfected by year/site
# male
Male<-subset(dm2_dip,dm2_dip$sex==1)
MT<-t(tapply(Male$mic,list(Male$year,Male$site),length))
MI<-t(tapply(Male$mic,list(Male$year,Male$site),sum))
MF<-MI/MT
longMF<-melt(MF,id=c("year","frequency"))

longFF<-na.omit(longFF)
longMF<-na.omit(longMF)

#means
m = c(mean(longFF$value),mean(longMF$value))
se = c((sd(longFF$value)/sqrt(length(longFF$value))),
       sd(longMF$value)/sqrt(length(longMF$value)))

# SUMMARY OF MICROPHALLUS PREVALENCE IN MALES V DIPLOID FEMALES
t22<-cbind(m,se)
colnames(t22)=c("mean prevalence microphallus","se of mean")
rownames(t22)=c("diploid females","males")
t22
```

Field Results in APPENDIX B. Prevalence of infection in sexual and asexual females by site. Figure B2

```{r}
# FIGURE B2

# MANIPULATION AND CALCULATIONS
#Sexuals
dataS<-subset(dp2,dp2$ploidy==0)
totalS<-t(tapply(dataS$mic,list(dataS$year,dataS$site),length))
micS<-t(tapply(dataS$mic,list(dataS$year,dataS$site),sum))
freqS<-micS/totalS

mean(na.omit(totalS))
sd(na.omit(totalS))/sqrt(30)

#Asexuals
dataA<-subset(dp2,dp2$ploidy==1)
totalA<-t(tapply(dataA$mic,list(dataA$year,dataA$site),length))
micA<-t(tapply(dataA$mic,list(dataA$year,dataA$site),sum))
freqA<-micA/totalA

mean(na.omit(totalA))
sd(na.omit(totalA))/sqrt(27)
#

# FIGURE B2
# SW End
SW<-t(rbind(freqS[5,],freqA[5,]))
tSW<-t(rbind(totalS[5,],totalA[5,]))
se_swe=sqrt((SW*(1-SW))/tSW)

# UPPER LEFT
par(las=1)
par(lwd=2)
par(col="gray20")
plot(SW[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","white"),
     xaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","white"))

axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
text(1.8,0.92,"Southwest End",cex=2,col="black")

arrows(c(1,2,3,4),SW[,1]-se_swe[,1],c(1,2,3,4),SW[,1]+se_swe[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(SW[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","white"),
  col=c("gray20","gray20","gray20","gray20","white"))

arrows(c(2.25),SW[,2]-se_swe[,2],c(2.25),SW[,2]+se_swe[,2],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=SW[,2],pch=23, cex=3, bg=c("#525252","#525252","white","white","white"),
       col=c("gray20","gray20","white","white","white"))
points(1.25,0.0,pch=22,cex=2,bg=c("white"),col="gray20",lwd=2,xpd=TRUE)

legend(3.5,1,legend=c("sexual females","asexual females"),pch=c(21,23),
       pt.bg=c("#bdbdbdbd","#525252"),
       col="gray10",pt.cex=1.5,cex=1,bty="n")
box()


boxplot(SW[,1],SW[,2],
        ylim=c(0,1),yaxt="n",
        ylab="",outcex=1.5,
        lwd=2,cex.axis=1,cex.names=2,
                names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(1,0.92,"Southwest End",cex=2.2,col="black")

######
#Camp
camp<-t(rbind(freqS[1,],freqA[1,]))
tcamp<-t(rbind(totalS[1,],totalA[1,]))
se_camp=sqrt((camp*(1-camp))/tcamp)

# UPPER RIGHT
plot(camp[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","white"),
     xaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","white"),
     yaxt="n")

axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
text(1.25,0.92,"Camp",cex=2,col="black")

arrows(c(1,2,3,4),camp[,1]-se_camp[,1],c(1,2,3,4),camp[,1]+se_camp[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(camp[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","white"),
       col=c("gray20","gray20","gray20","gray20","white"))

arrows(c(1.25,2.25,3.25,4.25,5.25),camp[,2]-se_camp[,2],c(1.25,2.25,3.25,4.25,5.25),camp[,2]+se_camp[,2],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1,
       col=c("gray20","white","white","gray20","gray20"))

points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=camp[,2],pch=23, cex=3, bg=c("#525252","white","white","#525252","#525252"),
       col=c("gray20","white","white","gray20","gray20"))
box()

boxplot(camp[,1],camp[,2],
        ylim=c(0,1),
        ylab="",yaxt="n",outcex=1.5,
        lwd=2,cex.axis=1,cex.names=1,
                names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(0.6,0.92,"Camp",cex=2.2,col="black")

######################
# WPoint
wp<-t(rbind(freqS[6,],freqA[6,]))
twp<-t(rbind(totalS[6,],totalA[6,]))
se_wp=sqrt((wp*(1-wp))/twp)

# MIDDLE LEFT
plot(wp[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
     xaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","gray20"))

axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)

text(1.55,0.92,"West Point",cex=2,col="black")

arrows(c(1,2,3,4,5),wp[,1]-se_wp[,1],c(1,2,3,4,5),wp[,1]+se_wp[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)

points(wp[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
       col=c("gray20","gray20","gray20","gray20","gray20"))

arrows(c(2.25,3.25,4.25,5.25),wp[2:5,2]-se_wp[2:5,2],c(2.25,3.25,4.25,5.25),wp[2:5,2]+se_wp[2:5,2],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1,
       col=c("gray20","white","white","gray20"))

points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=wp[,2],pch=23, cex=3, bg=c("white","#525252","white","white","#525252"),
       col=c("white","gray20","white","white","gray20"))

points(1.25,0.0,pch=22,cex=2,bg=c("white"),col="gray20",lwd=2,xpd=TRUE)

box()

boxplot(wp[,1],wp[,2],
        ylim=c(0,1),
        ylab="",yaxt="n",outcex=1.5,
        lwd=2,cex.axis=1,cex.names=1,
                names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(0.75,0.92,"West Point",cex=2.2,col="black")

#####################
#Halfway
half<-t(rbind(freqS[2,],freqA[2,]))
thalf<-t(rbind(totalS[2,],totalA[2,]))
se_half=sqrt((half*(1-half))/thalf)

# MIDDLE RIGHT
plot(half[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
     xaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","gray20"),
     yaxt="n")
axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)
text(1.35,0.92,"Halfway",cex=2,col="black")

arrows(c(1,2,3,4,5),half[,1]-se_half[,1],c(1,2,3,4,5),half[,1]+se_half[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(half[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
       col=c("gray20","gray20","gray20","gray20","gray20"))

arrows(c(2.25,3.25,4.25,5.25),half[2:5,2]-se_half[2:5,2],c(2.25,3.25,4.25,5.25),half[2:5,2]+se_half[2:5,2],       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1,
       col=c("white","white","white","gray20"))

points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=half[,2],pch=23, cex=3, bg=c("white","white","white","white","#525252"),
       col=c("white","white","white","white","gray20"))

points(1.25,0.0,pch=22,cex=2,bg=c("white"),col="gray20",lwd=2,xpd=TRUE)

box()

boxplot(half[,1],half[,2],
        ylim=c(0,1),
        ylab="",yaxt="n",outcex=1.5,
        lwd=2,cex.axis=1,cex.names=1,
                names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(0.65,0.92,"Halfway",cex=2.2,col="black")


####################
# JMS
jms<-t(rbind(freqS[3,],freqA[3,]))
tjms<-t(rbind(totalS[3,],totalA[3,]))
se_jms=sqrt((jms*(1-jms))/tjms)

# BOTTOM RIGHT
plot(jms[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
     xaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","gray20"))

axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)

text(1.25,0.92,"JMS",cex=2,col="black")

arrows(c(1,2,3,4,5),jms[,1]-se_jms[,1],c(1,2,3,4,5),jms[,1]+se_jms[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(jms[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
       col=c("gray20","gray20","gray20","gray20","gray20"))

arrows(c(1.25,2.25,3.25,4.25,5.25),jms[,2]-se_jms[,2],c(1.25,2.25,3.25,4.25,5.25),jms[,2]+se_jms[,2],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1,
       col=c("white","white","gray20","white","gray20"))

points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=jms[,2],pch=23, cex=3, bg=c("white","white","#525252","white","#525252"),
       col=c("white","white","gray20","white","gray20"))

box()

boxplot(jms[,1],jms[,2],
        ylim=c(0,1),
        ylab="",yaxt="n",
        lwd=2,cex.axis=1,cex.names=1,outcex=1.5,
        names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(0.575,0.92,"JMS",cex=2.2,col="black")

####################
# Swamp
swamp<-t(rbind(freqS[4,],freqA[4,]))
tswamp<-t(rbind(totalS[4,],totalA[4,]))
se_swamp=sqrt((swamp*(1-swamp))/tswamp)

# BOTTOM RIGHT
plot(swamp[,1],
     ylim=c(0,1),
     xlim=c(1,5.5),
     lwd=2,
     cex.axis=1,
     cex.lab=1,
     ylab="",
     xlab="",
     pch=21, cex=3, bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
     xaxt="n",yaxt="n",type="p",lty=1,col=c("gray20","gray20","gray20","gray20","gray20"))

axis(1, at=c(1.125,2.125,3.125,4.125,5.125),labels=c("2012","2013","2014","2015","2016"),
     cex.axis=1)

text(1.35,0.92,"Swamp",cex=2.2,col="black")

arrows(c(1,2,3,4,5),swamp[,1]-se_swamp[,1],c(1,2,3,4,5),swamp[,1]+se_swamp[,1],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1)
points(swamp[,1],pch=21, cex=3,bg=c("#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd"),
       col=c("gray20","gray20","gray20","gray20","gray20"))

arrows(c(1.25,2.25,3.25,4.25,5.25),swamp[,2]-se_swamp[,2],c(1.25,2.25,3.25,4.25,5.25),swamp[,2]+se_swamp[,2],
       code=3,      #arrow type
       angle=90,
       length=0.1,
       lwd=1,
       col=c("gray20","gray20","gray20","gray20","gray20"))

points(x=c(1.25,2.25,3.25,4.25,5.25),
       y=swamp[,2],pch=23, cex=3, bg=c("#525252","#525252","#525252","#525252","#525252"),
       col=c("gray20","gray20","gray20","gray20","gray20"))

box()

boxplot(swamp[,1],swamp[,2],
        ylim=c(0,1),
        ylab="",yaxt="n",
        lwd=2,cex.axis=1,cex.names=1,outcex=1.5,
        names=c("Sexual","Asexual"),
        col=c("#bdbdbd","#525252"))
text(0.65,0.92,"Swamp",cex=2.2,col="black")
```

Field Results in APPENDIX B. Comparison of sexual male and female infection rates in the field, 2012-2016. Figure B5

```{r}
# FIGURE B5

# MANIPULATION AND CALCULATIONS
# infected and uninfected by year/site
# female
Fem<-subset(dm2_dip,dm2_dip$sex==0)
FT<-t(tapply(Fem$mic,list(Fem$year,Fem$site),length))
FI<-t(tapply(Fem$mic,list(Fem$year,Fem$site),sum))
FF<-FI/FT
longFF<-melt(FF,id=c("year","frequency"))

# infected and uninfected by year/site
# male
Male<-subset(dm2_dip,dm2_dip$sex==1)
MT<-t(tapply(Male$mic,list(Male$year,Male$site),length))
MI<-t(tapply(Male$mic,list(Male$year,Male$site),sum))
MF<-MI/MT
longMF<-melt(MF,id=c("year","frequency"))

longFF<-na.omit(longFF)
longMF<-na.omit(longMF)

# FIGURE B5
par(las=1)
par(lwd=2)
par(col="gray20")
boxplot(longFF$value,longMF$value,
        ylim=c(0,1),ylab="", 
        lwd=2,cex.axis=1,names=c("Diploid Females","Males"),
        xlab="",outcex=1.5,
        col=c("#bdbdbd","white"))

# SAMPLE SIZE FIGURE S5
mm<-mean(MT)
sem<-sd(MT)/sqrt(30)
mf<-mean(FT)
sef<-sd(FT)/sqrt(30)

# SUMMARY SAMPLE SIZE FIGURE 25
t23<-matrix(c(mm,sem,mf,sef),nrow=2)
colnames(t23)=c("males","diploid females")
rownames(t23)=c("mean number","se of mean")
t23
```


